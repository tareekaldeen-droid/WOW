<!DOCTYPE html>
<html lang="ar" dir="rtl" translate="no" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- ğŸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ø´Ø§Ù…Ù„">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <meta name="theme-color" content="#0d7c66">
    <title>Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„ | Ultimate App</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ· (ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ù…Ù„) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Cairo:wght@300;400;500;600;700;800&family=Lateef&family=Tajawal:wght@300;400;500;700&family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@400;600&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* ============================================================ */
        /* ğŸ¨ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
        /* ============================================================ */
        :root {
            --primary-color: #0d7c66;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --header-bg: linear-gradient(135deg, #0d7c66, #084135);
            --app-font: 'Cairo', sans-serif; /* Ø§Ù„Ø®Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        [data-theme="dark"] {
            --primary-color: #4db6ac;
            --bg-color: #051311;
            --card-bg: #0f221e;
            --text-color: #e2e8e6;
            --text-secondary: #8b9d96;
            --border-color: #1f3a35;
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
            --header-bg: linear-gradient(135deg, #0f221e, #051311);
        }

        /* ğŸ› ï¸ Ø¥ØµÙ„Ø§Ø­ Ø­Ø¬Ù… Ø§Ù„Ø®Ø· (Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Root Font Size) */
        html { font-size: 16px; /* Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */ }
        html[data-font-size="xs"] { font-size: 13px; }
        html[data-font-size="sm"] { font-size: 14.5px; }
        html[data-font-size="md"] { font-size: 16px; }
        html[data-font-size="lg"] { font-size: 18px; }
        html[data-font-size="xl"] { font-size: 20px; }

        html, body {
            /* ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø· Ø§Ù„Ù…ØªØºÙŠØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
            font-family: var(--app-font) !important;
            transition: background-color 0.4s ease, color 0.3s ease;
            height: 100%;
            overflow-x: hidden;
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { padding-bottom: calc(80px + var(--safe-bottom)); line-height: 1.7; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .top-nav {
            background: var(--header-bg);
            padding: 0.8rem 1rem;
            padding-top: calc(0.8rem + var(--safe-top));
            position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15); color: white;
        }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 1.2rem; }
        .top-controls { display: flex; gap: 10px; align-items: center; }
        .icon-btn {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; width: 40px; height: 40px; cursor: pointer; color: white;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        .lang-select {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: bold;
        }
        .lang-select option { background: #333; color: white; }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø´Ø¨ÙƒØ© */
        .hero-card {
            background: linear-gradient(135deg, rgba(13, 124, 102, 0.1), rgba(13, 124, 102, 0.05));
            border: 1px solid var(--primary-color); border-radius: 24px; padding: 2rem; text-align: center; margin-bottom: 2rem;
        }
        .app-logo { width: 110px; height: 110px; background: white; border-radius: 50%; padding: 6px; margin: 0 auto 1rem; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .app-logo img { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; }

        .grid-menu { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media (min-width: 768px) { .grid-menu { grid-template-columns: repeat(3, 1fr); } }

        .menu-item {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 1.5rem 1rem;
            text-align: center; cursor: pointer; transition: transform 0.2s; box-shadow: var(--shadow);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .menu-item:active { transform: scale(0.95); }
        .menu-icon { width: 55px; height: 55px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-bottom: 12px; }

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
        .bg-green { background: rgba(46, 125, 50, 0.15); color: #2e7d32; }
        .bg-blue { background: rgba(21, 101, 192, 0.15); color: #1565c0; }
        .bg-purple { background: rgba(123, 31, 162, 0.15); color: #7b1fa2; }
        .bg-orange { background: rgba(239, 108, 0, 0.15); color: #ef6c00; }
        .bg-red { background: rgba(198, 40, 40, 0.15); color: #c62828; }
        .bg-teal { background: rgba(0, 105, 92, 0.15); color: #00695c; }
        .bg-gray { background: rgba(66, 66, 66, 0.15); color: #616161; }
        .bg-brown { background: rgba(121, 85, 72, 0.15); color: #795548; }
        [data-theme="dark"] .bg-green { color: #81c784; background: rgba(129, 199, 132, 0.1); }
        [data-theme="dark"] .bg-blue { color: #64b5f6; background: rgba(100, 181, 246, 0.1); }
        [data-theme="dark"] .bg-purple { color: #ba68c8; background: rgba(186, 104, 200, 0.1); }
        [data-theme="dark"] .bg-orange { color: #ffb74d; background: rgba(255, 183, 77, 0.1); }
        [data-theme="dark"] .bg-red { color: #e57373; background: rgba(229, 115, 115, 0.1); }
        [data-theme="dark"] .bg-teal { color: #4db6ac; background: rgba(77, 182, 172, 0.1); }
        [data-theme="dark"] .bg-gray { color: #e0e0e0; background: rgba(224, 224, 224, 0.1); }
        [data-theme="dark"] .bg-brown { color: #a1887f; background: rgba(161, 136, 127, 0.1); }

        .item-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 4px; }
        .item-desc { font-size: 0.85rem; color: var(--text-secondary); }

        /* Ø§Ù„ØµÙØ­Ø§Øª */
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .back-btn {
            display: inline-flex; align-items: center; gap: 10px; background: var(--card-bg); border: 1px solid var(--border-color);
            padding: 12px 24px; border-radius: 30px; color: var(--text-color); cursor: pointer; margin-bottom: 1.5rem; font-weight: bold; box-shadow: var(--shadow);
        }
        body[dir="ltr"] .back-btn span:first-child { transform: rotate(180deg); display: inline-block; }

        .empty-content { text-align: center; padding: 4rem 1rem; color: var(--text-secondary); border: 2px dashed var(--border-color); border-radius: 16px; background: var(--card-bg); }

        /* Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        .settings-group { background: var(--card-bg); border-radius: 20px; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border-color); box-shadow: var(--shadow); }
        .settings-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; color: var(--primary-color); display: flex; align-items: center; gap: 8px; }
        .settings-row { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .settings-row:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .label-text { display: block; margin-bottom: 10px; font-weight: bold; }
        .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; } 
        .theme-btn, .size-btn, .font-btn { padding: 12px; border: 2px solid var(--border-color); background: var(--bg-color); border-radius: 12px; cursor: pointer; color: var(--text-color); font-size: 1rem; transition: 0.2s; }
        .theme-btn.active, .size-btn.active, .font-btn.active { border-color: var(--primary-color); background: rgba(13, 124, 102, 0.1); color: var(--primary-color); font-weight: bold; }
        .size-controls { display: flex; gap: 5px; } .size-btn { flex: 1; }
        .font-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-around; padding: 12px 0; padding-bottom: calc(12px + var(--safe-bottom)); z-index: 999; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .nav-link { display: flex; flex-direction: column; align-items: center; color: var(--text-secondary); font-size: 0.8rem; cursor: pointer; width: 50%; transition: 0.2s; }
        .nav-link.active { color: var(--primary-color); font-weight: bold; transform: translateY(-2px); }
        .nav-link svg { width: 26px; height: 26px; fill: currentColor; margin-bottom: 4px; }

        /* ============================================================ */
        /* ğŸ”” Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Modal) */
        /* ============================================================ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            z-index: 3000; display: none; align-items: center; justify-content: center; padding: 20px;
            animation: fadeInOverlay 0.3s ease;
        }
        .modal-content {
            background: var(--card-bg); width: 100%; max-width: 400px;
            border-radius: 24px; padding: 1.5rem; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--border-color);
            transform: scale(0.9); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-logo { width: 70px; height: 70px; margin: 0 auto 10px; background: white; border-radius: 50%; padding: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .modal-logo img { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; }
        
        .modal-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 5px; color: var(--primary-color); }
        
        /* Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª */
        .modal-date {
            font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;
            background: rgba(0,0,0,0.05); padding: 4px 12px; border-radius: 20px; display: inline-block; font-weight: bold;
        }

        /* Ø§Ù„ØµÙˆØ±Ø© - Ø­ÙˆØ§Ù Ù…ÙƒØ³ÙˆØ±Ø©/Ù…Ù†Ø­Ù†ÙŠØ© */
        .modal-image {
            width: 100%; height: auto; max-height: 250px; object-fit: cover;
            border-radius: 16px; margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            display: none; /* Ù…Ø®ÙÙŠØ© Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ */
            border: 2px solid var(--border-color);
        }

        .modal-body { font-size: 1rem; color: var(--text-color); margin-bottom: 20px; line-height: 1.6; }
        
        .modal-btn {
            background: var(--primary-color); color: white; border: none; padding: 12px 24px;
            border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; font-size: 1rem;
            box-shadow: 0 4px 15px rgba(13, 124, 102, 0.3);
        }

        /* Ù‚Ø³Ù… Ù…Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .news-card { border: 1px solid var(--border-color); border-radius: 16px; padding: 15px; background: var(--bg-color); }
        .news-image { width: 100%; border-radius: 12px; margin-bottom: 10px; display: none; border: 1px solid var(--border-color); }
        .news-date { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px; display: block; font-weight: bold; }

        /* ØªØ¹Ù„ÙŠÙ…Ø§Øª iOS */
        .ios-instructions { text-align: right; margin-top: 10px; font-size: 0.9rem; color: var(--text-secondary); }
        .ios-step { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .ios-icon { font-size: 1.2rem; }

        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* ğŸªµ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ø¯ */
        .materials-grid { display: flex; flex-direction: column; gap: 15px; padding-bottom: 80px; }
        .category-header { 
            background: var(--bg-color); border-bottom: 2px solid var(--primary-color); 
            padding: 10px; font-weight: bold; color: var(--primary-color); margin-top: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .material-card {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px;
            padding: 10px; display: flex; gap: 10px; align-items: center; box-shadow: var(--shadow);
            transition: transform 0.2s;
        }
        .material-card:active { transform: scale(0.98); }
        .mat-thumb { 
            width: 60px; height: 60px; border-radius: 8px; object-fit: cover; background: #eee; border: 1px solid var(--border-color);
        }
        .mat-info { flex: 1; }
        .mat-name { font-weight: bold; font-size: 1rem; }
        .mat-price { color: var(--primary-color); font-weight: bold; font-size: 0.9rem; }
        .mat-unit { font-size: 0.8rem; color: var(--text-secondary); background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; }

        /* Inputs */
        .input-field {
            width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--bg-color); color: var(--text-color); margin-bottom: 10px;
        }
        .image-upload-box {
            width: 100%; height: 150px; border: 2px dashed var(--border-color); border-radius: 12px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 10px;
            background: rgba(0,0,0,0.02); overflow: hidden; position: relative;
        }

        /* Config List Items */
        .config-item { 
            display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid var(--border-color); 
        }
        .del-btn-small { color: #ef4444; cursor: pointer; padding: 0 5px; }

        /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; }
        }

        /* ğŸ› ï¸ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¹ØµØ±ÙŠ (Ø±Ø£Ø³ Ø«Ø§Ø¨Øª + Ù…Ø­ØªÙˆÙ‰ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ±) */
        .modal-content {
            display: flex;
            flex-direction: column;
            max-height: 85vh; /* Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ 85% Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
            padding: 0; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© */
            overflow: hidden; /* Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ù… */
            border-radius: 16px;
            background: var(--card-bg);
        }

        /* Ø§Ù„Ø±Ø£Ø³ Ø§Ù„Ø«Ø§Ø¨Øª (Sticky Header) */
        .modal-header {
            padding: 15px 20px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            font-size: 1.2rem; font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Ø¬Ø³Ù… Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ± (Scrollable Body) */
        .modal-body {
            flex: 1; /* ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© */
            overflow-y: auto; /* ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù‡Ù†Ø§ ÙÙ‚Ø· */
            padding: 20px;
        }

        /* ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„Ø£Ø²Ø±Ø§Ø±) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙŠÙƒÙˆÙ† Ø«Ø§Ø¨ØªØ§Ù‹ Ø£ÙŠØ¶Ø§Ù‹ */
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-color);
            display: flex; gap: 10px; justify-content: flex-end;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù„ØºØ§Øª */
        .lang-group {
            background: var(--bg-color); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 10px; margin-bottom: 15px;
        }
        .lang-row {
            display: flex; align-items: center; margin-bottom: 8px;
        }
        .lang-row:last-child { margin-bottom: 0; }
        .lang-flag {
            width: 40px; font-size: 0.8rem; font-weight: bold; color: var(--text-secondary);
            text-transform: uppercase; display: flex; align-items: center;
        }
        .lang-input {
            flex: 1; border: 1px solid var(--border-color); background: var(--card-bg);
            padding: 8px; border-radius: 6px; color: var(--text-color); outline: none;
        }
        .lang-input:focus { border-color: var(--primary-color); }

        /* Ø²Ø± Ø§Ù„Ù€Ù…ÙˆØ¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª FAB Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-fab-btn {
            width: 45px; height: 30px; 
            background: var(--primary-color); color: white;
            border-radius: 20px; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; margin-bottom: 2px;
            box-shadow: 0 4px 10px rgba(13, 124, 102, 0.4);
            transition: transform 0.2s;
        }
        .bottom-fab-btn:active { transform: scale(0.9); }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .action-menu {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) scale(0.8);
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 16px; padding: 10px; width: 200px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none; flex-direction: column; gap: 8px;
            z-index: 2000; opacity: 0; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .action-menu.active {
            display: flex; opacity: 1; transform: translateX(-50%) scale(1); bottom: 90px;
        }
        .action-item {
            background: var(--bg-color); border: none; padding: 12px; border-radius: 10px;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            font-family: inherit; font-weight: bold; color: var(--text-color);
            transition: background 0.2s;
        }
        .action-item:active { background: rgba(0,0,0,0.1); }

        /* Ø­Ù‚ÙˆÙ„ Ù„ØºØ§Øª Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª */
        .lang-input-group {
            display: flex; align-items: center; margin-bottom: 5px;
            border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;
        }
        .lang-badge {
            background: var(--border-color); color: var(--text-secondary);
            padding: 0 10px; font-size: 0.8rem; font-weight: bold;
            display: flex; align-items: center; height: 42px; width: 45px; justify-content: center;
        }
        .input-field.no-m { margin-bottom: 0; border: none; border-radius: 0; }
        .config-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid var(--border-color); font-size: 0.9rem;
        }

        /* Ø´Ø¨ÙƒØ© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª */
        .print-options-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 5px;
        }
        .print-card {
            background: var(--bg-color); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 15px 5px; text-align: center;
            cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 5px;
            font-size: 0.9rem;
        }
        .print-card:hover { background: rgba(0,0,0,0.05); }
        .print-card.active {
            border-color: var(--primary-color); background: rgba(13, 124, 102, 0.1);
            color: var(--primary-color); font-weight: bold;
        }
        /* ØªØ¹Ø·ÙŠÙ„ Ø®ÙŠØ§Ø± Ø§Ù„Ø¨Ø­Ø« Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹ */
        .print-card.disabled {
            opacity: 0.5; cursor: not-allowed; pointer-events: none;
        }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ù„Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª */
        .compact-search-wrapper {
            display: flex;
            align-items: center;
            background: var(--bg-color); /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© */
            border: 1px solid var(--border-color);
            border-radius: 30px; /* ØªØ¯ÙˆÙŠØ± ÙƒØ§Ù…Ù„ Ù„Ù„Ø­ÙˆØ§Ù */
            padding: 6px 12px; /* Ø­Ø´ÙˆØ© ØµØºÙŠØ±Ø© Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø© */
            margin: 10px 15px; /* Ù‡ÙˆØ§Ù…Ø´ Ø¬Ø§Ù†Ø¨ÙŠØ© Ù…Ø¹Ù‚ÙˆÙ„Ø© */
            height: 40px; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª ÙˆØµØºÙŠØ± */
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            transition: all 0.2s ease;
        }

        /* ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© */
        .compact-search-wrapper:focus-within {
            border-color: var(--primary-color);
            background: var(--card-bg);
            box-shadow: 0 4px 12px rgba(13, 124, 102, 0.15);
            transform: translateY(-1px);
        }

        /* Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
        .search-icon {
            color: #999;
            display: flex;
            align-items: center;
            margin-left: 5px; /* Ù…Ø³Ø§ÙØ© ØµØºÙŠØ±Ø© */
        }

        /* Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .compact-search-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 0.9rem; /* Ø®Ø· Ø£ØµØºØ± Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
            color: var(--text-color);
            font-family: inherit;
            padding: 0 5px;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø®ÙÙŠ */
        .compact-search-input::placeholder {
            color: #bbb;
            font-size: 0.85rem;
            transition: color 0.2s;
        }
        .compact-search-wrapper:focus-within .compact-search-input::placeholder {
            color: #ccc;
        }








/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª */
.dimension-row, .cbm-row {
    transition: all 0.3s ease;
}

.dimension-row:hover, .cbm-row:hover {
    background: rgba(13, 124, 102, 0.1) !important;
}

.selected-material-item {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.selected-material-item img {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 6px;
}

.selected-material-info {
    flex: 1;
}

.selected-material-controls {
    display: flex;
    align-items: center;
    gap: 5px;
}

.quantity-input {
    width: 60px;
    padding: 4px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    text-align: center;
}

.material-selector-item {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.material-selector-item:hover {
    background: rgba(13, 124, 102, 0.1);
    border-color: var(--primary-color);
}

.material-selector-item.selected {
    background: rgba(13, 124, 102, 0.15);
    border-color: var(--primary-color);
    box-shadow: 0 2px 8px rgba(13, 124, 102, 0.2);
}

/* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ÙˆØ§Ù„Ù€ CBM */
.dimension-input, .cbm-input {
    font-size: 0.9rem;
    text-align: center;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª */
.model-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: var(--shadow);
    transition: transform 0.2s, box-shadow 0.2s;
}

.model-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.model-card-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 10px;
}

.model-card-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.model-card-info {
    flex: 1;
}

.model-card-title {
    font-size: 1.1rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.model-card-type {
    font-size: 0.85rem;
    color: var(--text-secondary);
    background: rgba(0,0,0,0.05);
    padding: 2px 8px;
    border-radius: 12px;
    display: inline-block;
}

.model-card-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
}

.model-detail-item {
    text-align: center;
    padding: 8px;
    background: var(--bg-color);
    border-radius: 6px;
}

.model-detail-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 2px;
}

.model-detail-value {
    font-weight: bold;
    color: var(--primary-color);
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª */
.model-actions-btn {
    position: fixed;
    bottom: 100px;
    left: 20px;
    width: 60px;
    height: 60px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(13, 124, 102, 0.4);
    transition: transform 0.2s;
    z-index: 1000;
    display: none;
}

.model-actions-btn:active {
    transform: scale(0.9);
}

/* Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª */
.model-action-menu {
    position: fixed;
    bottom: 170px;
    left: 20px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 10px;
    width: 200px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: none;
    flex-direction: column;
    gap: 8px;
    z-index: 2000;
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.model-action-menu.active {
    display: flex;
    opacity: 1;
    transform: scale(1);
}















    </style>
</head>
<body>

    <!-- ğŸ–¨ï¸ Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="printModal" class="modal-overlay" style="z-index: 5000;">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom:15px;">
                <span data-ar="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©" data-en="Print Options" data-tr="YazdÄ±rma SeÃ§enekleri">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</span>
            </h3>

            <!-- 1. Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
            <label class="label-text" data-ar="Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±" data-en="Report Type" data-tr="Rapor TÃ¼rÃ¼">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
            <div class="print-options-grid">
                <div class="print-card active" onclick="selectPrintType(this, 'all')">
                    <span>ğŸ“‘</span>
                    <span data-ar="Ø§Ù„ÙƒÙ„" data-en="All" data-tr="TÃ¼mÃ¼">Ø§Ù„ÙƒÙ„</span>
                </div>
                <div class="print-card" onclick="selectPrintType(this, 'search')" id="optSearch">
                    <span>ğŸ”</span>
                    <span data-ar="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«" data-en="Search Results" data-tr="Arama SonuÃ§larÄ±">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</span>
                </div>
                <div class="print-card" onclick="selectPrintType(this, 'cat')">
                    <span>ğŸ“‚</span>
                    <span data-ar="Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ" data-en="By Category" data-tr="Kategoriye GÃ¶re">Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ</span>
                </div>
            </div>

            <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØµÙ†ÙŠÙ) -->
            <div id="printCatSelectWrapper" style="display:none; margin-top:10px;">
                <select id="printCatSelect" class="input-field"></select>
            </div>

            <div style="margin-top:15px; display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="printIncImg" checked style="width:18px; height:18px;">
                <label for="printIncImg" data-ar="ØªØ¶Ù…ÙŠÙ† Ø§Ù„ØµÙˆØ±" data-en="Include Images" data-tr="Resimleri Dahil Et">ØªØ¶Ù…ÙŠÙ† Ø§Ù„ØµÙˆØ±</label>
            </div>

            <hr style="margin: 15px 0; border:0; border-top:1px solid var(--border-color);">

            <!-- 2. Ù„ØºØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
            <label class="label-text" data-ar="Ù„ØºØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±" data-en="Report Language" data-tr="Rapor Dili">Ù„ØºØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
            <select id="printLangSelect" class="input-field">
                <option value="current" data-ar="Ù„ØºØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠØ©" data-en="Current App Language" data-tr="Mevcut Uygulama Dili">Ù„ØºØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</option>
                <option value="all" data-ar="Ø´Ø§Ù…Ù„ (3 Ù„ØºØ§Øª)" data-en="Trilingual (All 3)" data-tr="ÃœÃ§ Dilli (TÃ¼mÃ¼)">Ø´Ø§Ù…Ù„ (3 Ù„ØºØ§Øª)</option>
                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)</option>
                <option value="en">English</option>
                <option value="tr">TÃ¼rkÃ§e</option>
            </select>

            <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="modal-btn" onclick="executePrint()">
                    <span data-ar="Ø·Ø¨Ø§Ø¹Ø©" data-en="Print" data-tr="YazdÄ±r">Ø·Ø¨Ø§Ø¹Ø©</span> ğŸ–¨ï¸
                </button>
                <button class="modal-btn" style="background:#666;" onclick="document.getElementById('printModal').style.display='none'">
                    <span data-ar="Ø¥Ù„ØºØ§Ø¡" data-en="Cancel" data-tr="Ä°ptal">Ø¥Ù„ØºØ§Ø¡</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ğŸ”” Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (Modal) -->
    <div id="notificationModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-logo">
                <img src="https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=375,h=378,fit=crop,trim=68.26666666666667;68.26666666666667;68.26666666666667;68.26666666666667/a5oqci6YCwpNHTpH/whatsapp-image-2025-12-19-at-11.11.04-am-fDCDqijtAhLk7CFm.png" alt="Logo">
            </div>
            
            <h3 class="modal-title" id="notifTitle">ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯!</h3>
            
            <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª -->
            <div id="notifDate" class="modal-date"></div>

            <!-- ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± -->
            <img id="notifImage" src="" class="modal-image" alt="Update Image">

            <p class="modal-body" id="notifBody">...</p>
            
            <button class="modal-btn" onclick="dismissNotification()" data-ar="Ù„Ù‚Ø¯ Ù‚Ø±Ø£ØªØŒ Ù„Ø§ ØªØ¸Ù‡Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰" data-en="I read it, don't show again" data-tr="Okudum, tekrar gÃ¶sterme">Ù„Ù‚Ø¯ Ù‚Ø±Ø£ØªØŒ Ù„Ø§ ØªØ¸Ù‡Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
        </div>
    </div>

    <!-- ğŸ“² Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª Ù„Ù„Ø¢ÙŠÙÙˆÙ† -->
    <div id="iosInstallModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-logo">
                <img src="https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=375,h=378,fit=crop,trim=68.26666666666667;68.26666666666667;68.26666666666667;68.26666666666667/a5oqci6YCwpNHTpH/whatsapp-image-2025-12-19-at-11.11.04-am-fDCDqijtAhLk7CFm.png" alt="Logo">
            </div>
            <h3 class="modal-title" data-ar="ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" data-en="Install App" data-tr="UygulamayÄ± YÃ¼kle">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
            <div class="ios-instructions">
                <div class="ios-step">
                    <span class="ios-icon">1ï¸âƒ£</span>
                    <span data-ar="Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø§Ù„Ø£Ø³ÙÙ„" data-en="Tap the Share button below" data-tr="AÅŸaÄŸÄ±daki PaylaÅŸ dÃ¼ÄŸmesine basÄ±n">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø§Ù„Ø£Ø³ÙÙ„</span>
                    <span style="font-size:1.2rem">â‹</span>
                </div>
                <div class="ios-step">
                    <span class="ios-icon">2ï¸âƒ£</span>
                    <span data-ar="Ø§Ø®ØªØ± 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'" data-en="Select 'Add to Home Screen'" data-tr="'Ana Ekrana Ekle'yi seÃ§in">Ø§Ø®ØªØ± 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'</span>
                    <span style="font-size:1.2rem">â•</span>
                </div>
            </div>
            <button class="modal-btn" style="margin-top:15px; background:#333;" onclick="closeIosModal()" data-ar="Ø­Ø³Ù†Ø§Ù‹ØŒ ÙÙ‡Ù…Øª" data-en="Got it" data-tr="AnladÄ±m">Ø­Ø³Ù†Ø§Ù‹ØŒ ÙÙ‡Ù…Øª</button>
        </div>
    </div>

    <!-- ğŸ§­ Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <nav class="top-nav">
        <div class="logo">
            <span class="nav-icon" id="headerIcon">ğŸ </span>
            <span id="headerTitle" data-ar="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" data-tr="Ana Sayfa" data-en="Home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </div>
        <div class="top-controls">
            <button class="icon-btn" id="headerThemeBtn" onclick="toggleHeaderTheme()">â˜€ï¸</button>
            <select class="lang-select" id="langSelect" onchange="changeLanguage(this.value)">
                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                <option value="en">English</option>
                <option value="tr">TÃ¼rkÃ§e</option>
            </select>
        </div>
    </nav>

    <div class="container">
        <!-- ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div id="homePage" class="page active">
            <div class="hero-card">
                <div class="app-logo">
                    <img src="https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=375,h=378,fit=crop,trim=68.26666666666667;68.26666666666667;68.26666666666667;68.26666666666667/a5oqci6YCwpNHTpH/whatsapp-image-2025-12-19-at-11.11.04-am-fDCDqijtAhLk7CFm.png" alt="Logo">
                </div>
                <h2 data-ar="Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„" data-tr="KapsamlÄ± Uygulama" data-en="Ultimate App">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„</h2>
                <p style="opacity: 0.8;" data-ar="Ø¨ÙˆØ§Ø¨ØªÙƒ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©" data-tr="Entegre hizmetler portalÄ±nÄ±z" data-en="Your portal for integrated services">Ø¨ÙˆØ§Ø¨ØªÙƒ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</p>
            </div>
            <div class="grid-menu" id="menuGrid"></div>
        </div>

        <!-- ğŸ“„ ØµÙØ­Ø© Ø§Ù„Ù‚Ø³Ù… -->
        <div id="sectionPage" class="page">
            <button class="back-btn" onclick="goHome()"><span>âœ</span><span data-ar="Ø§Ù„Ø¹ÙˆØ¯Ø©" data-tr="Geri" data-en="Back">Ø§Ù„Ø¹ÙˆØ¯Ø©</span></button>
            <div class="empty-content">
                <div style="font-size: 4rem; margin-bottom: 1rem;" id="secIcon">ğŸš§</div>
                <h2 id="secTitle" style="margin-bottom: 10px;">Title</h2>
                <p data-ar="Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±" data-tr="Bu bÃ¶lÃ¼m yapÄ±m aÅŸamasÄ±ndadÄ±r" data-en="This section is under development">Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</p>
            </div>
        </div>

        <!-- ğŸ“° ØµÙØ­Ø© "Ù…Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯" -->
        <div id="whatsNewPage" class="page">
            <button class="back-btn" onclick="openSection(12)"><span>âœ</span><span data-ar="Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª" data-tr="Ayarlara DÃ¶n" data-en="Back to Settings">Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></button>
            <div class="settings-group">
                <div class="settings-header">
                    <span>ğŸ“¢</span> <span data-ar="Ø¢Ø®Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª" data-tr="Son GÃ¼ncellemeler" data-en="Latest Updates">Ø¢Ø®Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</span>
                </div>
                
                <div id="whatsNewContent" class="news-card">
                    <span id="newsDate" class="news-date"></span>
                    <img id="newsImage" src="" class="news-image">
                    <div id="newsText" style="line-height:1.8; color:var(--text-color);">
                        <p data-ar="Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹." data-en="No updates recorded yet." data-tr="HenÃ¼z kayÄ±tlÄ± gÃ¼ncelleme yok.">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ğŸªµ ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª -->
        <div id="materialsPage" class="page">
            <!-- Ø´Ø±ÙŠØ· Ø¨Ø­Ø« Ù…Ø¯Ù…Ø¬ Ø°ÙƒÙŠ Ù…Ø¹ ØªÙ‚Ù†ÙŠØ© Debounce -->
            <div class="compact-search-wrapper">
                <div class="search-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <input type="text" id="matSearch" class="compact-search-input" 
                       oninput="debouncedSearch()"
                       placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø©..." 
                       data-ph-ar="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø©..." 
                       data-ph-en="Search material..." 
                       data-ph-tr="Malzeme ara...">
            </div>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ (ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹) -->
            <div id="materialsList" class="materials-grid"></div>
        </div>

        <!-- ğŸ› ï¸ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø© (Sticky Header + 3 Langs) -->
        <div id="materialModal" class="modal-overlay" style="z-index: 4000;">
            <div class="modal-content" style="width: 100%; max-width: 550px;">
                
                <!-- Ø§Ù„Ø±Ø£Ø³ Ø§Ù„Ø«Ø§Ø¨Øª -->
                <div class="modal-header">
                    <span id="matModalTitle">Title</span>
                    <span onclick="closeMatModal()" style="cursor:pointer; opacity:0.6;">âœ•</span>
                </div>

                <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ± -->
                <div class="modal-body">
                    <input type="hidden" id="matId">
                    
                    <!-- Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ®Ø²ÙŠÙ† -->
                    <div class="image-upload-box" onclick="document.getElementById('matImgInput').click()" style="margin-bottom:20px;">
                        <img id="matPreview" src="" style="display:none; width:100%; height:100%; object-fit:contain;">
                        <span id="matUploadPlaceholder" data-ar="ğŸ“¸ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø¯Ø©" data-en="ğŸ“¸ Material Image" data-tr="ğŸ“¸ Malzeme Resmi">ğŸ“¸ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø¯Ø©</span>
                    </div>
                    <input type="file" id="matImgInput" hidden accept="image/*" onchange="handleImageUpload(this)">

                    <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© (3 Ù„ØºØ§Øª) Ù…Ø¹ ØªØ¹Ù‚ÙŠÙ… Ø§Ù„Ù†ØµÙˆØµ -->
                    <label class="label-text" data-ar="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" data-en="Material Name" data-tr="Malzeme AdÄ±">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                    <div class="lang-group">
                        <div class="lang-row"><span class="lang-flag">AR</span><input type="text" id="matNameAr" class="lang-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"></div>
                        <div class="lang-row"><span class="lang-flag">EN</span><input type="text" id="matNameEn" class="lang-input" placeholder="Name in English"></div>
                        <div class="lang-row"><span class="lang-flag">TR</span><input type="text" id="matNameTr" class="lang-input" placeholder="TÃ¼rkÃ§e Ä°sim"></div>
                    </div>

                    <!-- Ø§Ù„ØªØµÙ†ÙŠÙ ÙˆØ§Ù„ÙˆØ­Ø¯Ø© -->
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div style="flex:1;">
                            <label class="label-text">
                                <span data-ar="Ø§Ù„ØªØµÙ†ÙŠÙ" data-en="Category" data-tr="Kategori">Ø§Ù„ØªØµÙ†ÙŠÙ</span>
                                <span onclick="manageCategories()" style="color:var(--primary-color); cursor:pointer; font-size:1.2rem;">âš™ï¸</span>
                            </label>
                            <select id="matCategory" class="input-field"></select>
                        </div>
                        <div style="flex:1;">
                            <label class="label-text">
                                <span data-ar="Ø§Ù„ÙˆØ­Ø¯Ø©" data-en="Unit" data-tr="Birim">Ø§Ù„ÙˆØ­Ø¯Ø©</span>
                                <span onclick="manageUnits()" style="color:var(--primary-color); cursor:pointer; font-size:1.2rem;">âš™ï¸</span>
                            </label>
                            <select id="matUnit" class="input-field"></select>
                        </div>
                    </div>

                    <!-- Ø§Ù„Ø³Ø¹Ø± Ù…Ø¹ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø© -->
                    <label class="label-text" data-ar="Ø§Ù„Ø³Ø¹Ø±" data-en="Price" data-tr="Fiyat">Ø§Ù„Ø³Ø¹Ø±</label>
                    <div style="display:flex; align-items:center; gap:10px; background:var(--bg-color); padding:10px; border-radius:10px;">
                        <input type="number" id="matPrice" class="input-field" style="margin:0; flex:1;" placeholder="0.00" oninput="calculateSecondaryPrice()">
                        <span id="primaryCurrLabelModal" style="font-weight:bold;">USD</span>
                        <span style="font-size:1.5rem;">â”</span>
                        <span id="secondaryPriceDisplay" style="font-weight:bold; color:var(--primary-color);">0</span>
                        <span id="secondaryCurrLabelModal" style="font-size:0.9rem;">TRY</span>
                    </div>
                </div>

                <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø«Ø§Ø¨Øª -->
                <div class="modal-footer">
                    <button id="btnDeleteMat" class="modal-btn" style="background:#ef4444; display:none;" onclick="deleteMaterial()">
                        <span data-ar="Ø­Ø°Ù" data-en="Delete" data-tr="Sil">Ø­Ø°Ù</span>
                    </button>
                    <button class="modal-btn" style="background:#666;" onclick="closeMatModal()">
                        <span data-ar="Ø¥Ù„ØºØ§Ø¡" data-en="Cancel" data-tr="Ä°ptal">Ø¥Ù„ØºØ§Ø¡</span>
                    </button>
                    <button class="modal-btn" onclick="saveMaterial()">
                        <span data-ar="Ø­ÙØ¸" data-en="Save" data-tr="Kaydet">Ø­ÙØ¸</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- âš™ï¸ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© (Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª/Ø§Ù„ÙˆØ­Ø¯Ø§Øª) - Sticky Header -->
        <div id="configModal" class="modal-overlay" style="z-index: 4100;">
            <div class="modal-content" style="width: 100%; max-width: 450px;">
                <div class="modal-header">
                    <span id="configTitle">Management</span>
                    <span onclick="document.getElementById('configModal').style.display='none'" style="cursor:pointer; opacity:0.6;">âœ•</span>
                </div>
                
                <div class="modal-body">
                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± -->
                    <ul id="configList" style="list-style:none; padding:0; margin-bottom:20px;"></ul>

                    <!-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯ -->
                    <label class="label-text" data-ar="Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯ (3 Ù„ØºØ§Øª)" data-en="Add New (3 Langs)" data-tr="Yeni Ekle (3 Dil)">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</label>
                    <div class="lang-group">
                        <div class="lang-row"><span class="lang-flag">AR</span><input type="text" id="confAr" class="lang-input" placeholder="Ø¹Ø±Ø¨ÙŠ"></div>
                        <div class="lang-row"><span class="lang-flag">EN</span><input type="text" id="confEn" class="lang-input" placeholder="English"></div>
                        <div class="lang-row"><span class="lang-flag">TR</span><input type="text" id="confTr" class="lang-input" placeholder="TÃ¼rkÃ§e"></div>
                    </div>
                    <button onclick="addConfigItem()" class="modal-btn" style="width:100%;">
                        <span data-ar="Ø¥Ø¶Ø§ÙØ©" data-en="Add" data-tr="Ekle">Ø¥Ø¶Ø§ÙØ©</span> +
                    </button>
                </div>
            </div>
        </div>






<!-- ğŸ›‹ï¸ ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª -->
<div id="modelsPage" class="page">
    <!-- Ø´Ø±ÙŠØ· Ø¨Ø­Ø« Ù…Ø¯Ù…Ø¬ Ø°ÙƒÙŠ -->
    <div class="compact-search-wrapper">
        <div class="search-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </div>
        <input type="text" id="modelSearch" class="compact-search-input" 
               oninput="debouncedModelSearch()"
               placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¯ÙŠÙ„..." 
               data-ph-ar="Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¯ÙŠÙ„..." 
               data-ph-en="Search model..." 
               data-ph-tr="Model ara...">
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª -->
    <div id="modelsList" class="materials-grid"></div>
</div>

<!-- ğŸ› ï¸ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¯ÙŠÙ„ -->
<div id="modelModal" class="modal-overlay" style="z-index: 4000;">
    <div class="modal-content" style="width: 100%; max-width: 650px;">
        
        <!-- Ø§Ù„Ø±Ø£Ø³ Ø§Ù„Ø«Ø§Ø¨Øª -->
        <div class="modal-header">
            <span id="modelModalTitle">Title</span>
            <span onclick="closeModelModal()" style="cursor:pointer; opacity:0.6;">âœ•</span>
        </div>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ± -->
        <div class="modal-body">
            <input type="hidden" id="modelId">
            
            <!-- Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© -->
            <div class="image-upload-box" onclick="document.getElementById('modelImgInput').click()" style="margin-bottom:20px;">
                <img id="modelPreview" src="" style="display:none; width:100%; height:100%; object-fit:contain;">
                <span id="modelUploadPlaceholder" data-ar="ğŸ“¸ ØµÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„" data-en="ğŸ“¸ Model Image" data-tr="ğŸ“¸ Model Resmi">ğŸ“¸ ØµÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</span>
            </div>
            <input type="file" id="modelImgInput" hidden accept="image/*" onchange="handleModelImageUpload(this)">

            <!-- Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© (3 Ù„ØºØ§Øª) -->
            <label class="label-text" data-ar="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©" data-en="Piece Name" data-tr="ParÃ§a AdÄ±">Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
            <div class="lang-group">
                <div class="lang-row"><span class="lang-flag">AR</span><input type="text" id="modelNameAr" class="lang-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"></div>
                <div class="lang-row"><span class="lang-flag">EN</span><input type="text" id="modelNameEn" class="lang-input" placeholder="Name in English"></div>
                <div class="lang-row"><span class="lang-flag">TR</span><input type="text" id="modelNameTr" class="lang-input" placeholder="TÃ¼rkÃ§e Ä°sim"></div>
            </div>

            <!-- Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·Ø¹Ø© -->
            <div style="margin-bottom:15px;">
                <label class="label-text">
                    <span data-ar="Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·Ø¹Ø©" data-en="Piece Type" data-tr="ParÃ§a TÃ¼rÃ¼">Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·Ø¹Ø©</span>
                    <span onclick="manageModelTypes()" style="color:var(--primary-color); cursor:pointer; font-size:1.2rem;">âš™ï¸</span>
                </label>
                <select id="modelType" class="input-field"></select>
            </div>

         <!-- Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù‚Ø·Ø¹Ø© -->
<label class="label-text" data-ar="Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù‚Ø·Ø¹Ø©" data-en="Piece Dimensions" data-tr="ParÃ§a BoyutlarÄ±">Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
<div id="dimensionsContainer" style="margin-bottom:15px;">
    <div class="dimension-row" style="display:flex; align-items:center; gap:5px; margin-bottom:10px; background:var(--bg-color); padding:10px; border-radius:8px;">
        <input type="number" class="input-field dimension-input dimension-length" style="flex:1; margin:0;" step="0.01" 
               data-ph-ar="Ø§Ù„Ø·ÙˆÙ„" data-ph-en="Length" data-ph-tr="Uzunluk" placeholder="Ø§Ù„Ø·ÙˆÙ„">
        <span>Ã—</span>
        <input type="number" class="input-field dimension-input dimension-width" style="flex:1; margin:0;" step="0.01" 
               data-ph-ar="Ø§Ù„Ø¹Ø±Ø¶" data-ph-en="Width" data-ph-tr="GeniÅŸlik" placeholder="Ø§Ù„Ø¹Ø±Ø¶">
        <span>Ã—</span>
        <input type="number" class="input-field dimension-input dimension-height" style="flex:1; margin:0;" step="0.01" 
               data-ph-ar="Ø§Ù„Ø§Ø±ØªÙØ§Ø¹" data-ph-en="Height" data-ph-tr="YÃ¼kseklik" placeholder="Ø§Ù„Ø§Ø±ØªÙØ§Ø¹">
        <button type="button" onclick="removeDimensionRow(this)" class="del-btn-small" style="background:#ef4444; color:white; border:none; padding:5px; border-radius:4px;">ğŸ—‘ï¸</button>
    </div>
</div>
<button type="button" onclick="addDimensionRow()" class="modal-btn" style="width:100%; margin-bottom:15px; background:#28a745;">
    <span data-ar="Ø¥Ø¶Ø§ÙØ© Ø¨ÙØ¹Ø¯ Ø¬Ø¯ÙŠØ¯" data-en="Add New Dimension" data-tr="Yeni Boyut Ekle">Ø¥Ø¶Ø§ÙØ© Ø¨ÙØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</span> â•
</button>

<!-- Ø§Ù„ÙˆØµÙ -->
<label class="label-text" data-ar="Ø§Ù„ÙˆØµÙ" data-en="Description" data-tr="AÃ§Ä±klama">Ø§Ù„ÙˆØµÙ</label>
<div class="lang-group">
    <div class="lang-row"><span class="lang-flag">AR</span><textarea id="modelDescAr" class="lang-input" rows="2" placeholder="Ø§Ù„ÙˆØµÙ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"></textarea></div>
    <div class="lang-row"><span class="lang-flag">EN</span><textarea id="modelDescEn" class="lang-input" rows="2" placeholder="Description in English"></textarea></div>
    <div class="lang-row"><span class="lang-flag">TR</span><textarea id="modelDescTr" class="lang-input" rows="2" placeholder="TÃ¼rkÃ§e AÃ§Ä±klama"></textarea></div>
</div>

<!-- Ø­Ø§Ø³Ø¨Ø© CBM -->
<label class="label-text" data-ar="Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø­Ø¬Ù… (CBM)" data-en="Volume Calculator (CBM)" data-tr="Hacim HesaplayÄ±cÄ± (CBM)">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø­Ø¬Ù… (CBM)</label>
<div id="cbmContainer" style="margin-bottom:15px;">
    <div class="cbm-row" style="display:flex; align-items:center; gap:5px; margin-bottom:10px; background:rgba(13, 124, 102, 0.05); padding:10px; border-radius:8px; border:1px solid var(--primary-color);">
        <input type="number" class="input-field cbm-input cbm-length" style="flex:1; margin:0;" step="0.01" oninput="calculateCBM()" 
               data-ph-ar="Ø§Ù„Ø·ÙˆÙ„" data-ph-en="Length" data-ph-tr="Uzunluk" placeholder="Ø§Ù„Ø·ÙˆÙ„">
        <span>Ã—</span>
        <input type="number" class="input-field cbm-input cbm-width" style="flex:1; margin:0;" step="0.01" oninput="calculateCBM()" 
               data-ph-ar="Ø§Ù„Ø¹Ø±Ø¶" data-ph-en="Width" data-ph-tr="GeniÅŸlik" placeholder="Ø§Ù„Ø¹Ø±Ø¶">
        <span>Ã—</span>
        <input type="number" class="input-field cbm-input cbm-height" style="flex:1; margin:0;" step="0.01" oninput="calculateCBM()" 
               data-ph-ar="Ø§Ù„Ø§Ø±ØªÙØ§Ø¹" data-ph-en="Height" data-ph-tr="YÃ¼kseklik" placeholder="Ø§Ù„Ø§Ø±ØªÙØ§Ø¹">
        <button type="button" onclick="removeCBMRow(this)" class="del-btn-small" style="background:#ef4444; color:white; border:none; padding:5px; border-radius:4px;">ğŸ—‘ï¸</button>
    </div>
</div>
<button type="button" onclick="addCBMRow()" class="modal-btn" style="width:100%; margin-bottom:10px; background:#17a2b8;">
    <span data-ar="Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ CBM Ø¬Ø¯ÙŠØ¯" data-en="Add New CBM Field" data-tr="Yeni CBM AlanÄ± Ekle">Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ CBM Ø¬Ø¯ÙŠØ¯</span> â•
</button>

            
            <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒÙ„ÙŠ -->
            <div style="background:var(--primary-color); color:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:15px;">
                <strong data-ar="Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒÙ„ÙŠ: " data-en="Total Volume: " data-tr="Toplam Hacim: ">Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒÙ„ÙŠ: </strong>
                <span id="totalCBM">0.00</span> <span>CBM</span>
            </div>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <div>
                    <label class="label-text" data-ar="Ø§Ù„Ù„ÙˆÙ†" data-en="Color" data-tr="Renk">Ø§Ù„Ù„ÙˆÙ†</label>
                    <input type="text" id="modelColor" class="input-field" placeholder="Ø£Ø¨ÙŠØ¶ / White / Beyaz">
                </div>
                <div>
                    <label class="label-text" data-ar="Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)" data-en="Weight (Kg)" data-tr="AÄŸÄ±rlÄ±k (Kg)">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label>
                    <input type="number" id="modelWeight" class="input-field" step="0.01">
                </div>
            </div>

            <div>
                <label class="label-text" data-ar="Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø§ÙƒÙŠØª" data-en="Number of Packets" data-tr="Paket SayÄ±sÄ±">Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø§ÙƒÙŠØª</label>
                <input type="number" id="modelPackets" class="input-field" min="1" value="1">
            </div>

            <!-- Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ -->
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:15px;">
                <div>
                    <label class="label-text" data-ar="ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù…Ø§Ù„Ø©" data-en="Labor Cost" data-tr="Ä°ÅŸÃ§ilik Maliyeti">ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù…Ø§Ù„Ø©</label>
                    <input type="number" id="modelLaborCost" class="input-field" step="0.01" oninput="calculateModelTotalCost()">
                </div>
                <div>
                    <label class="label-text" data-ar="Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø£Ø®Ø±Ù‰" data-en="Other Costs" data-tr="DiÄŸer Maliyetler">Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø£Ø®Ø±Ù‰</label>
                    <input type="number" id="modelOtherCosts" class="input-field" step="0.01" oninput="calculateModelTotalCost()">
                </div>
                <div>
                    <label class="label-text" data-ar="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹" data-en="Selling Price" data-tr="SatÄ±ÅŸ FiyatÄ±">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
                    <input type="number" id="modelSellingPrice" class="input-field" step="0.01">
                </div>
            </div>

            <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
            <label class="label-text" data-ar="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" data-en="Notes" data-tr="Notlar">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <textarea id="modelNotes" class="input-field" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>

            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯ -->
            <div style="margin-bottom:15px;">
                <label class="label-text" data-ar="Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©" data-en="Used Materials" data-tr="KullanÄ±lan Malzemeler">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</label>
                <button type="button" onclick="openMaterialSelector()" class="modal-btn" style="width:100%; background:#6f42c1;">
                    <span data-ar="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯" data-en="Select Materials" data-tr="Malzeme SeÃ§">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯</span> ğŸ§±
                </button>
                
                <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© -->
                <div id="selectedMaterialsList" style="margin-top:10px;"></div>
            </div>

            <!-- Ø¹Ø±Ø¶ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© -->
            <div style="background:linear-gradient(135deg, #28a745, #20c997); color:white; padding:15px; border-radius:12px; text-align:center;">
                <h4 style="margin:0 0 10px 0;" data-ar="Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©" data-en="Total Cost" data-tr="Toplam Maliyet">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</h4>
                <div style="font-size:1.2rem; font-weight:bold;">
                    <span id="modelTotalCostPrimary">0</span> <span id="modelCostCurrPrimary">USD</span>
                    <br>
                    <span style="font-size:0.9rem; opacity:0.9;">
                        <span id="modelTotalCostSecondary">0</span> <span id="modelCostCurrSecondary">TRY</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø«Ø§Ø¨Øª -->
        <div class="modal-footer">
            <button id="btnDeleteModel" class="modal-btn" style="background:#ef4444; display:none;" onclick="deleteModel()">
                <span data-ar="Ø­Ø°Ù" data-en="Delete" data-tr="Sil">Ø­Ø°Ù</span>
            </button>
            <button class="modal-btn" style="background:#666;" onclick="closeModelModal()">
                <span data-ar="Ø¥Ù„ØºØ§Ø¡" data-en="Cancel" data-tr="Ä°ptal">Ø¥Ù„ØºØ§Ø¡</span>
            </button>
            <button class="modal-btn" onclick="saveModel()">
                <span data-ar="Ø­ÙØ¸" data-en="Save" data-tr="Kaydet">Ø­ÙØ¸</span>
            </button>
        </div>
    </div>
</div>

<!-- ğŸ§± Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯ -->
<div id="materialSelectorModal" class="modal-overlay" style="z-index: 4100;">
    <div class="modal-content" style="width: 100%; max-width: 600px;">
        <div class="modal-header">
            <span data-ar="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯" data-en="Select Materials" data-tr="Malzeme SeÃ§imi">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯</span>
            <span onclick="closeMaterialSelector()" style="cursor:pointer; opacity:0.6;">âœ•</span>
        </div>
        
        <div class="modal-body">
            <!-- Ø¨Ø­Ø« Ø§Ù„Ù…ÙˆØ§Ø¯ -->
            <div class="compact-search-wrapper" style="margin:0 0 15px 0;">
                <div class="search-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <input type="text" id="materialSelectorSearch" class="compact-search-input" 
                       oninput="filterMaterialsInSelector()"
                       placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø©..." 
                       data-ph-ar="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø©..." 
                       data-ph-en="Search material..." 
                       data-ph-tr="Malzeme ara...">
            </div>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ -->
            <div id="materialSelectorList" style="max-height:400px; overflow-y:auto;"></div>
        </div>

        <div class="modal-footer">
            <button class="modal-btn" onclick="closeMaterialSelector()">
                <span data-ar="Ø¥ØºÙ„Ø§Ù‚" data-en="Close" data-tr="Kapat">Ø¥ØºÙ„Ø§Ù‚</span>
            </button>
        </div>
    </div>
</div>

<!-- âš™ï¸ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª -->
<div id="modelTypesModal" class="modal-overlay" style="z-index: 4100;">
    <div class="modal-content" style="width: 100%; max-width: 450px;">
        <div class="modal-header">
            <span data-ar="Ø¥Ø¯Ø§Ø±Ø© Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª" data-en="Manage Model Types" data-tr="Model TÃ¼rlerini YÃ¶net">Ø¥Ø¯Ø§Ø±Ø© Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª</span>
            <span onclick="document.getElementById('modelTypesModal').style.display='none'" style="cursor:pointer; opacity:0.6;">âœ•</span>
        </div>
        
        <div class="modal-body">
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ -->
            <ul id="modelTypesList" style="list-style:none; padding:0; margin-bottom:20px;"></ul>

            <!-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯ -->
            <label class="label-text" data-ar="Ø¥Ø¶Ø§ÙØ© Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ (3 Ù„ØºØ§Øª)" data-en="Add New Type (3 Langs)" data-tr="Yeni TÃ¼r Ekle (3 Dil)">Ø¥Ø¶Ø§ÙØ© Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</label>
            <div class="lang-group">
                <div class="lang-row"><span class="lang-flag">AR</span><input type="text" id="modelTypeAr" class="lang-input" placeholder="Ø¹Ø±Ø¨ÙŠ"></div>
                <div class="lang-row"><span class="lang-flag">EN</span><input type="text" id="modelTypeEn" class="lang-input" placeholder="English"></div>
                <div class="lang-row"><span class="lang-flag">TR</span><input type="text" id="modelTypeTr" class="lang-input" placeholder="TÃ¼rkÃ§e"></div>
            </div>
            <button onclick="addModelType()" class="modal-btn" style="width:100%;">
                <span data-ar="Ø¥Ø¶Ø§ÙØ©" data-en="Add" data-tr="Ekle">Ø¥Ø¶Ø§ÙØ©</span> +
            </button>
        </div>
    </div>
</div>

<!-- ğŸ–¨ï¸ Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª -->
<div id="modelPrintModal" class="modal-overlay" style="z-index: 5000;">
    <div class="modal-content" style="max-width: 550px;">
        <h3 style="margin-bottom:15px;">
            <span data-ar="Ø®ÙŠØ§Ø±Ø§Øª Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª" data-en="Model Print Options" data-tr="Model YazdÄ±rma SeÃ§enekleri">Ø®ÙŠØ§Ø±Ø§Øª Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª</span>
        </h3>

        <!-- Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
        <label class="label-text" data-ar="Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±" data-en="Report Type" data-tr="Rapor TÃ¼rÃ¼">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
        <div class="print-options-grid">
            <div class="print-card active" onclick="selectModelPrintType(this, 'all')">
                <span>ğŸ“‘</span>
                <span data-ar="Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª" data-en="All Models" data-tr="TÃ¼m Modeller">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª</span>
            </div>
            <div class="print-card" onclick="selectModelPrintType(this, 'search')" id="modelOptSearch">
                <span>ğŸ”</span>
                <span data-ar="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«" data-en="Search Results" data-tr="Arama SonuÃ§larÄ±">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</span>
            </div>
            <div class="print-card" onclick="selectModelPrintType(this, 'type')">
                <span>ğŸ“‚</span>
                <span data-ar="Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹" data-en="By Type" data-tr="TÃ¼re GÃ¶re">Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</span>
            </div>
        </div>

        <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù†ÙˆØ¹ -->
        <div id="modelPrintTypeSelectWrapper" style="display:none; margin-top:10px;">
            <select id="modelPrintTypeSelect" class="input-field"></select>
        </div>

        <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
        <div style="margin-top:15px;">
            <label class="label-text" data-ar="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ±" data-en="Report Content" data-tr="Rapor Ä°Ã§eriÄŸi">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <label style="display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" id="printModelImages" checked>
                    <span data-ar="ØªØ¶Ù…ÙŠÙ† Ø§Ù„ØµÙˆØ±" data-en="Include Images" data-tr="Resimleri Dahil Et">ØªØ¶Ù…ÙŠÙ† Ø§Ù„ØµÙˆØ±</span>
                </label>
                <label style="display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" id="printModelMaterials" checked>
                    <span data-ar="ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯" data-en="Include Materials" data-tr="Malzemeleri Dahil Et">ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯</span>
                </label>
                <label style="display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" id="printModelPrices" checked>
                    <span data-ar="ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø£Ø³Ø¹Ø§Ø±" data-en="Include Prices" data-tr="FiyatlarÄ± Dahil Et">ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</span>
                </label>
                <label style="display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" id="printModelDimensions" checked>
                    <span data-ar="ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯" data-en="Include Dimensions" data-tr="BoyutlarÄ± Dahil Et">ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</span>
                </label>
            </div>
        </div>

        <hr style="margin: 15px 0; border:0; border-top:1px solid var(--border-color);">

        <!-- Ù„ØºØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
        <label class="label-text" data-ar="Ù„ØºØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±" data-en="Report Language" data-tr="Rapor Dili">Ù„ØºØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
        <select id="modelPrintLangSelect" class="input-field">
            <option value="current" data-ar="Ù„ØºØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠØ©" data-en="Current App Language" data-tr="Mevcut Uygulama Dili">Ù„ØºØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</option>
            <option value="all" data-ar="Ø´Ø§Ù…Ù„ (3 Ù„ØºØ§Øª)" data-en="Trilingual (All 3)" data-tr="ÃœÃ§ Dilli (TÃ¼mÃ¼)">Ø´Ø§Ù…Ù„ (3 Ù„ØºØ§Øª)</option>
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)</option>
            <option value="en">English</option>
            <option value="tr">TÃ¼rkÃ§e</option>
        </select>

        <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="modal-btn" onclick="executeModelPrint()">
                <span data-ar="Ø·Ø¨Ø§Ø¹Ø©" data-en="Print" data-tr="YazdÄ±r">Ø·Ø¨Ø§Ø¹Ø©</span> ğŸ–¨ï¸
            </button>
            <button class="modal-btn" style="background:#666;" onclick="document.getElementById('modelPrintModal').style.display='none'">
                <span data-ar="Ø¥Ù„ØºØ§Ø¡" data-en="Cancel" data-tr="Ä°ptal">Ø¥Ù„ØºØ§Ø¡</span>
            </button>
        </div>
    </div>
</div>







        <!-- âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        <div id="settingsPage" class="page">
            <button class="back-btn" onclick="goHome()"><span>âœ</span><span data-ar="Ø§Ù„Ø¹ÙˆØ¯Ø©" data-tr="Geri" data-en="Back">Ø§Ù„Ø¹ÙˆØ¯Ø©</span></button>

            <!-- Ø²Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
            <div class="settings-group" id="installGroup">
                <div class="settings-header">
                    <span>ğŸ“²</span> <span data-ar="Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" data-tr="Uygulama" data-en="Application">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
                </div>
                <button class="modal-btn" onclick="installApp()" style="margin-bottom:10px;">
                    <span data-ar="ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ" data-tr="UygulamayÄ± YÃ¼kle" data-en="Install App">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ</span>
                </button>
            </div>

            <!-- Ø²Ø± Ù…Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
            <div class="settings-group">
                <div class="settings-header">
                    <span>âœ¨</span> <span data-ar="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª" data-tr="Bilgi" data-en="Info">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</span>
                </div>
                <div class="settings-row" onclick="openWhatsNew()" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                    <span class="label-text" style="margin:0" data-ar="Ù…Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±ØŸ" data-tr="Bu sÃ¼rÃ¼mdeki yenilikler?" data-en="What's new in this version?">Ù…Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±ØŸ</span>
                    <span>âœ</span>
                </div>
            </div>

            <div class="settings-group">
                <div class="settings-header"><span>ğŸ¨</span> <span data-ar="Ø§Ù„Ù…Ø¸Ù‡Ø±" data-tr="GÃ¶rÃ¼nÃ¼m" data-en="Appearance">Ø§Ù„Ù…Ø¸Ù‡Ø±</span></div>
                <div class="settings-row">
                    <span class="label-text" data-ar="Ø§Ù„Ù†Ù…Ø·" data-tr="Mod" data-en="Mode">Ø§Ù„Ù†Ù…Ø·</span>
                    <div class="theme-grid">
                        <button class="theme-btn" onclick="setAppTheme('light')" data-theme-val="light"><span>â˜€ï¸</span><span data-ar="Ù†Ù‡Ø§Ø±ÙŠ" data-tr="GÃ¼ndÃ¼z" data-en="Light">Ù†Ù‡Ø§Ø±ÙŠ</span></button>
                        <button class="theme-btn" onclick="setAppTheme('dark')" data-theme-val="dark"><span>ğŸŒ™</span><span data-ar="Ù„ÙŠÙ„ÙŠ" data-tr="Gece" data-en="Dark">Ù„ÙŠÙ„ÙŠ</span></button>
                        <button class="theme-btn" onclick="setAppTheme('auto')" data-theme-val="auto"><span>âš™ï¸</span><span data-ar="ØªÙ„Ù‚Ø§Ø¦ÙŠ" data-tr="Otomatik" data-en="Auto">ØªÙ„Ù‚Ø§Ø¦ÙŠ</span></button>
                    </div>
                </div>
                <div class="settings-row">
                    <span class="label-text" data-ar="Ø­Ø¬Ù… Ø§Ù„Ù†Øµ" data-tr="YazÄ± Boyutu" data-en="Font Size">Ø­Ø¬Ù… Ø§Ù„Ù†Øµ</span>
                    <div class="size-controls">
                        <button class="size-btn" onclick="setFontSize('xs')" data-size="xs">XS</button>
                        <button class="size-btn" onclick="setFontSize('sm')" data-size="sm">S</button>
                        <button class="size-btn" onclick="setFontSize('md')" data-size="md">M</button>
                        <button class="size-btn" onclick="setFontSize('lg')" data-size="lg">L</button>
                        <button class="size-btn" onclick="setFontSize('xl')" data-size="xl">XL</button>
                    </div>
                </div>
                <div class="settings-row">
                    <span class="label-text" data-ar="Ø§Ù„Ø®Ø·" data-tr="YazÄ± Tipi" data-en="Font">Ø§Ù„Ø®Ø·</span>
                    <div class="font-grid" id="fontOptionsContainer"></div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Øª -->
            <div class="settings-group">
                <div class="settings-header"><span>ğŸ’±</span> <span data-ar="Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ§Ù„ØµØ±Ù" data-tr="DÃ¶viz KurlarÄ±" data-en="Currencies">Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ§Ù„ØµØ±Ù</span></div>
                
                <div class="settings-row">
                    <span class="label-text">Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Primary)</span>
                    <select id="currPrimary" class="input-field" onchange="saveCurrencySettings()">
                        <option value="USD">Dollar ($)</option>
                        <option value="EUR">Euro (â‚¬)</option>
                        <option value="TRY">Lira (â‚º)</option>
                        <option value="SYP">Syrian Pound (SYP)</option>
                    </select>
                </div>

                <div class="settings-row">
                    <span class="label-text">Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© (Secondary)</span>
                    <select id="currSecondary" class="input-field" onchange="saveCurrencySettings()">
                        <option value="TRY">Lira (â‚º)</option>
                        <option value="USD">Dollar ($)</option>
                        <option value="EUR">Euro (â‚¬)</option>
                        <option value="SYP">Syrian Pound (SYP)</option>
                    </select>
                </div>

                <div class="settings-row">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="label-text">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù (Exchange Rate)</span>
                        <label style="font-size:0.8rem;">
                            <input type="checkbox" id="autoRateToggle" onchange="toggleAutoRate()"> ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…Ù† Ø§Ù„Ù†Øª)
                        </label>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
                        <span>1 <span id="rateFromLabel">USD</span> = </span>
                        <input type="number" id="exchangeRateVal" class="input-field" style="width:100px;" onchange="saveCurrencySettings()">
                        <span id="rateToLabel">TRY</span>
                    </div>
                    <button id="fetchRateBtn" onclick="fetchLiveRate()" style="margin-top:10px; font-size:0.8rem; padding:5px 10px; background:var(--primary-color); color:white; border:none; border-radius:8px;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¢Ù† ğŸ”„</button>
                </div>
            </div>

            <div class="settings-group">
                <div class="settings-header"><span>ğŸ’¾</span> <span data-ar="Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" data-tr="Veri" data-en="Data">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span></div>
                <button style="width: 100%; padding: 14px; background: #ef4444; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;" onclick="resetApp()">
                    <span data-ar="Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" data-tr="UygulamayÄ± SÄ±fÄ±rla" data-en="Reset Application">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ğŸ”˜ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯) -->
    <div id="matActionMenu" class="action-menu">
        <button onclick="openMaterialModal(); toggleMatMenu()" class="action-item">
        <span>â•</span> <span data-ar="Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©" data-tr="Malzeme Ekle" data-en="Add Material">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</span>
        </button>
        <button onclick="showPrintOptions(); toggleMatMenu()" class="action-item">
            <span>ğŸ–¨ï¸</span> <span data-ar="Ø·Ø¨Ø§Ø¹Ø©" data-tr="YazdÄ±r" data-en="Print">Ø·Ø¨Ø§Ø¹Ø©</span>
        </button>
    </div>

    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ -->
    <nav class="bottom-nav">
        <!-- Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø«Ø§Ø¨Øª) -->
        <div class="nav-link active" onclick="goHome()">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg> 
            <span data-ar="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" data-tr="Ana Sayfa" data-en="Home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </div>

        <!-- Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ÙŠØ¸Ù‡Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) -->
        <div id="navSettingsBtn" class="nav-link" onclick="openSection(12)">
            <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg> 
            <span data-ar="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª" data-tr="Ayarlar" data-en="Settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
        </div>

    <div id="navMaterialsBtn" class="nav-link" style="display:none;" onclick="toggleMatMenu()">
    <div class="bottom-fab-btn">âš¡</div>
    <span id="navActionText" style="font-weight:bold; color:var(--primary-color);">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</span>
</div>



    <script>
        /* ============================================================ */
        /* ğŸŒŸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© */
        /* ============================================================ */
        
        // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ø¹ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
        const sectionsDB = [
            { id: 1,  icon: 'ğŸ“–', color: 'bg-green',  ar: 'Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…', tr: 'Kuran-Ä± Kerim', en: 'The Holy Quran' },
            { id: 2,  icon: 'ğŸªµ', color: 'bg-brown',   ar: 'Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª', tr: 'Malzemeler', en: 'Materials' },
            { id: 3,  icon: 'ğŸ›‹ï¸', color: 'bg-purple', ar: 'Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª',    tr: 'Modeller',        en: 'Models' },
            { id: 4,  icon: 'ğŸ“…', color: 'bg-orange', ar: 'Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù‡Ø¬Ø±ÙŠ Ø³',tr: 'Hicri Takvim',    en: 'Hijri Calendar' },
            { id: 5,  icon: 'ğŸ§­', color: 'bg-red',    ar: 'Ø§Ù„Ù‚Ø¨Ù„Ø©',        tr: 'KÄ±ble',           en: 'Qibla' },
            { id: 6,  icon: 'ğŸ“š', color: 'bg-teal',   ar: 'Ø§Ù„Ù…ÙƒØªØ¨Ø©',       tr: 'KÃ¼tÃ¼phane',       en: 'Library' },
            { id: 7,  icon: 'ğŸ“»', color: 'bg-gray',   ar: 'Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©',       tr: 'Radyo',           en: 'Radio' },
            { id: 8,  icon: 'ğŸ’¡', color: 'bg-green',  ar: 'Ø®ÙˆØ§Ø·Ø±',         tr: 'DÃ¼ÅŸÃ¼nceler',      en: 'Reflections' },
            { id: 9,  icon: 'ğŸ•‹', color: 'bg-brown',  ar: 'Ø§Ù„Ø­Ø¬ ÙˆØ§Ù„Ø¹Ù…Ø±Ø©',  tr: 'Hac ve Umre',     en: 'Hajj & Umrah' },
            { id: 10, icon: 'ğŸ¤²', color: 'bg-blue',   ar: 'Ø£Ø¯Ø¹ÙŠØ©',         tr: 'Dualar',          en: 'Supplications' },
            { id: 11, icon: 'ğŸ“¢', color: 'bg-purple', ar: 'Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª',     tr: 'Duyurular',       en: 'Announcements' },
            { id: 12, icon: 'âš™ï¸', color: 'bg-gray',   ar: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',     tr: 'Ayarlar',         en: 'Settings' }
        ];

        // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ· Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
        const fontsDB = {
            ar: [{ name: 'Cairo', label: 'ÙƒØ§ÙŠØ±Ùˆ' }, { name: 'Amiri', label: 'Ø£Ù…ÙŠØ±ÙŠ' }, { name: 'Tajawal', label: 'ØªØ¬ÙˆÙ‘Ù„' }, { name: 'Lateef', label: 'Ù„Ø·ÙŠÙ' }],
            en: [{ name: 'Roboto', label: 'Roboto' }, { name: 'Open Sans', label: 'Open Sans' }, { name: 'Montserrat', label: 'Montserrat' }],
            tr: [{ name: 'Roboto', label: 'Roboto' }, { name: 'Open Sans', label: 'Open Sans' }, { name: 'Montserrat', label: 'Montserrat' }]
        };

        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let currentLang = 'ar'; // Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
        let deferredPrompt; // Ù…ØªØºÙŠØ± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        let currentNotifId = 0; // Ù…Ø¹Ø±Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ

        /* ============================================================ */
        /* ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© */
        /* ============================================================ */
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => {
            detectInitialLanguage(); // ÙƒØ´Ù Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…ÙØ¶Ù„Ø©
            loadPreferences(); // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            renderMenu(); // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            setAppTheme(localStorage.getItem('appThemePref') || 'auto'); // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ù…Ø­ÙÙˆØ¸
            checkRemoteNotifications(); // ÙØ­Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            
            // ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
            });
        });

        /* ============================================================ */
        /* ğŸ”” Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (Remote Notifications) */
        /* ============================================================ */
        
        // ÙØ­Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
        async function checkRemoteNotifications() {
            try {
                // Ø¬Ù„Ø¨ Ù…Ù„Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
                const response = await fetch(`notifications.json?t=${new Date().getTime()}`);
                if (!response.ok) return;

                const data = await response.json();
                currentNotifId = data.id;

                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙƒØ§Ù…Ù„Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
                localStorage.setItem('latest_news_data', JSON.stringify(data));

                // ÙØ­Øµ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ Ø±ÙØ¶ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ø³Ø¨Ù‚Ø§Ù‹
                const dismissedId = localStorage.getItem('dismissed_notif_id');

                // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯ ÙˆÙ†Ø´Ø·
                if (data.id > (dismissedId || 0) && data.active) {
                    showModal(data);
                }
            } catch (error) { 
                console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø£Ùˆ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); 
            }
        }

        // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function showModal(data) {
            const modal = document.getElementById('notificationModal');
            const title = document.getElementById('notifTitle');
            const body = document.getElementById('notifBody');
            const dateEl = document.getElementById('notifDate');
            const imgEl = document.getElementById('notifImage');

            // Ø¹Ù†Ø§ÙˆÙŠÙ† Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù„ØºØ§Øª Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±
            const titles = { ar: "ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯!", en: "New Update!", tr: "Yeni GÃ¼ncelleme!" };
            title.textContent = titles[currentLang];
            body.textContent = data.message[currentLang] || data.message['ar'];
            
            // Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
            if(dateEl) dateEl.textContent = data.date || '';
            
            // Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø°Ø§ ØªÙˆÙØ±Øª
            if (imgEl) {
                if (data.image && data.image.trim() !== "") {
                    imgEl.src = data.image;
                    imgEl.style.display = 'block';
                } else {
                    imgEl.style.display = 'none';
                }
            }

            modal.style.display = 'flex';
        }

        // Ø±ÙØ¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙˆØ¹Ø¯Ù… Ø¥Ø¸Ù‡Ø§Ø±Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        function dismissNotification() {
            localStorage.setItem('dismissed_notif_id', currentNotifId);
            document.getElementById('notificationModal').style.display = 'none';
        }

        /* ============================================================ */
        /* ğŸ“° ØµÙØ­Ø© "Ù…Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯" */
        /* ============================================================ */
        
        // ÙØªØ­ ØµÙØ­Ø© Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        function openWhatsNew() {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('whatsNewPage').classList.add('active');
            
            const textDiv = document.getElementById('newsText');
            const imgDiv = document.getElementById('newsImage');
            const dateDiv = document.getElementById('newsDate');
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
            const storedData = localStorage.getItem('latest_news_data');
            
            if (storedData) {
                const data = JSON.parse(storedData);
                // Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø­Ø³Ø¨ Ù„ØºØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                if(textDiv) textDiv.textContent = data.message[currentLang] || data.message['ar'];
                if(dateDiv) dateDiv.textContent = data.date || '';
                
                // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
                if (imgDiv) {
                    if (data.image && data.image.trim() !== "") {
                        imgDiv.src = data.image;
                        imgDiv.style.display = 'block';
                    } else {
                        imgDiv.style.display = 'none';
                    }
                }
            }
        }

        /* ============================================================ */
        /* ğŸ“² Ù†Ø¸Ø§Ù… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (PWA Installation) */
        /* ============================================================ */
        
        // ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²
        function installApp() {
            const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent);
            
            if (isIos) {
                // Ø¹Ø±Ø¶ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ«Ø¨ÙŠØª Ù„Ø£Ø¬Ù‡Ø²Ø© iOS
                document.getElementById('iosInstallModal').style.display = 'flex';
            } else if (deferredPrompt) {
                // ØªØ«Ø¨ÙŠØª ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ ÙˆØ§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => { 
                    deferredPrompt = null; 
                });
            } else {
                // Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø£Ùˆ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…
                alert(currentLang === 'ar' ? 'Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…' : 'App already installed or not supported');
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªØ¹Ù„ÙŠÙ…Ø§Øª iOS
        function closeIosModal() { 
            document.getElementById('iosInstallModal').style.display = 'none'; 
        }

        /* ============================================================ */
        /* ğŸ¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆØ§Ù„Ø«ÙŠÙ…Ø§Øª (Theme System) */
        /* ============================================================ */
        
        // ØªØ·Ø¨ÙŠÙ‚ Ù†Ù…Ø· Ø§Ù„Ù…Ø¸Ù‡Ø± (ÙØ§ØªØ­/Ø¯Ø§ÙƒÙ†/ØªÙ„Ù‚Ø§Ø¦ÙŠ)
        function setAppTheme(pref) {
            localStorage.setItem('appThemePref', pref);
            
            // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ù…Ø· ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.querySelectorAll('.theme-btn').forEach(b => { 
                b.classList.remove('active'); 
                if(b.dataset.themeVal === pref) b.classList.add('active'); 
            });
            
            if(pref === 'auto') {
                // ÙƒØ´Ù ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(isDark ? 'dark' : 'light');
            } else { 
                applyTheme(pref); 
            }
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ù…Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        function applyTheme(t) { 
            document.documentElement.setAttribute('data-theme', t); 
            document.getElementById('headerThemeBtn').textContent = t === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸'; 
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ù…Ù† Ø²Ø± Ø§Ù„Ù‡ÙŠØ¯Ø±
        function toggleHeaderTheme() { 
            const c = document.documentElement.getAttribute('data-theme') || 'light'; 
            setAppTheme(c === 'dark' ? 'light' : 'dark'); 
        }

        /* ============================================================ */
        /* ğŸŒ Ù†Ø¸Ø§Ù… Ø§Ù„Ù„ØºØ§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ (Multi-language System) */
        /* ============================================================ */
        
        // ØªØºÙŠÙŠØ± Ù„ØºØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
       // ØªØºÙŠÙŠØ± Ù„ØºØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
function changeLanguage(lang) {
    currentLang = lang; 
    localStorage.setItem('appLang', lang); 
    document.getElementById('langSelect').value = lang;
    
    // ØªØ­Ø¯ÙŠØ« Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù†Øµ ÙˆØ®Ø§ØµÙŠØ© Ø§Ù„Ù„ØºØ©
    document.documentElement.lang = lang; 
    document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
    
    // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.querySelectorAll('[data-ar]').forEach(el => 
        el.textContent = el.getAttribute(`data-${lang}`)
    );
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø®Ø·ÙˆØ·
    renderMenu(); 
    renderFontOptions();
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø· Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØºØ©
    const f = localStorage.getItem(`appFont_${lang}`); 
    setFontFamily(f || (lang === 'ar' ? 'Cairo' : 'Roboto'));
    
    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ù…ÙˆØ§Ø¯
    const searchInput = document.getElementById('matSearch');
    if(searchInput) {
        const newPh = searchInput.getAttribute(`data-ph-${currentLang}`);
        if(newPh) searchInput.placeholder = newPh;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
    const modelSearchInput = document.getElementById('modelSearch');
    if (modelSearchInput) {
        const newPh = modelSearchInput.getAttribute(`data-ph-${currentLang}`);
        if (newPh) modelSearchInput.placeholder = newPh;
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    if (typeof allModels !== 'undefined' && allModels.length > 0) {
        renderModels(allModels);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
    if (typeof loadModelTypesData === 'function') {
        loadModelTypesData();
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø²Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
    updateActionButtonText();
}

        
        // ÙƒØ´Ù Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        function detectInitialLanguage() { 
            const s = localStorage.getItem('appLang'); 
            if(s) {
                changeLanguage(s); 
            } else { 
                // ÙƒØ´Ù Ù„ØºØ© Ø§Ù„Ù…ØªØµÙØ­
                const b = navigator.language; 
                if(b.startsWith('ar')) changeLanguage('ar'); 
                else if(b.startsWith('tr')) changeLanguage('tr'); 
                else changeLanguage('en'); 
            } 
        }












// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø²Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
function updateActionButtonText() {
    const actionText = document.getElementById('navActionText');
    if (!actionText) return;
    
    const currentPage = document.querySelector('.page.active');
    if (!currentPage) return;
    
    let newText = '';
    
    switch (currentPage.id) {
        case 'materialsPage':
            const materialTexts = {
                ar: 'Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª',
                en: 'Materials', 
                tr: 'Malzemeler'
            };
            newText = materialTexts[currentLang];
            break;
            
        case 'modelsPage':
            const modelTexts = {
                ar: 'Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª',
                en: 'Models',
                tr: 'Modeller'
            };
            newText = modelTexts[currentLang];
            break;
            
        default:
            const defaultTexts = {
                ar: 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª',
                en: 'Actions',
                tr: 'Ä°ÅŸlemler'
            };
            newText = defaultTexts[currentLang];
            break;
    }
    
    actionText.textContent = newText;
}









        /* ============================================================ */
        /* ğŸ  Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ§Ù„ØªÙ†Ù‚Ù„ */
        /* ============================================================ */
        
        // Ø¹Ø±Ø¶ Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function renderMenu() {
            const g = document.getElementById('menuGrid'); 
            g.innerHTML = '';
            
            sectionsDB.forEach(s => {
                const d = document.createElement('div'); 
                d.className = 'menu-item'; 
                d.onclick = () => openSection(s.id);
                
                // ØªÙƒÙˆÙŠÙ† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                d.innerHTML = `
                    <div class="menu-icon ${s.color}">${s.icon}</div>
                    <div class="item-title">${s[currentLang]}</div>
                    <div class="item-desc">${currentLang==='ar'?'Ø§Ù†Ù‚Ø± Ù„Ù„Ø¯Ø®ÙˆÙ„':(currentLang==='tr'?'Girmek iÃ§in tÄ±kla':'Tap to enter')}</div>
                `;
                g.appendChild(d);
            });
        }

        // ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ù…ÙˆØ§Ø¯
        function toggleMatMenu() {
            const menu = document.getElementById('matActionMenu');
            if (menu.classList.contains('active')) {
                menu.classList.remove('active');
                setTimeout(() => menu.style.display = 'none', 200);
            } else {
                menu.style.display = 'flex';
                setTimeout(() => menu.classList.add('active'), 10);
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('matActionMenu');
            const btn = document.getElementById('navMaterialsBtn');
            if (!menu.contains(e.target) && !btn.contains(e.target) && menu.classList.contains('active')) {
                toggleMatMenu();
            }
        });

        // ÙØªØ­ Ù‚Ø³Ù… Ù…Ø¹ÙŠÙ†
        function openSection(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
            document.getElementById('matActionMenu').classList.remove('active');
            document.getElementById('matActionMenu').style.display = 'none';

            const s = sectionsDB.find(x => x.id === id);
            const t = document.getElementById('headerTitle'); 
            const i = document.getElementById('headerIcon');
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
            t.setAttribute('data-ar', s.ar); 
            t.setAttribute('data-tr', s.tr); 
            t.setAttribute('data-en', s.en);
            t.textContent = s[currentLang]; 
            i.textContent = s.icon;

            // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ
            const settingsBtn = document.getElementById('navSettingsBtn');
            const materialsBtn = document.getElementById('navMaterialsBtn');

            if (id === 2) { 
                // Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª
                document.getElementById('materialsPage').classList.add('active');
                if(typeof loadMaterials === 'function') loadMaterials();
                
                settingsBtn.style.display = 'none';
                materialsBtn.style.display = 'flex';
            } 
            else {
                // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰
                settingsBtn.style.display = 'flex';
                materialsBtn.style.display = 'none';

                if(id === 12) {
                    // ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    document.getElementById('settingsPage').classList.add('active');
                } else {
                    // ØµÙØ­Ø© Ù‚Ø³Ù… Ø¹Ø§Ù…
                    document.getElementById('secTitle').textContent = s[currentLang];
                    document.getElementById('secIcon').textContent = s.icon;
                    document.getElementById('sectionPage').classList.add('active');
                }
            }
            window.scrollTo(0,0);
        }

        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
function goHome() {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
    document.getElementById('homePage').classList.add('active');
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†ØµÙˆØµ Ø§Ù„Ù‡ÙŠØ¯Ø±
    const t = document.getElementById('headerTitle'); 
    t.setAttribute('data-ar','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'); 
    t.setAttribute('data-tr','Ana Sayfa'); 
    t.setAttribute('data-en','Home');
    t.textContent = t.getAttribute(`data-${currentLang}`); 
    document.getElementById('headerIcon').textContent = 'ğŸ '; 
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
    document.getElementById('navSettingsBtn').style.display = 'flex';
    document.getElementById('navMaterialsBtn').style.display = 'none';
    document.getElementById('matActionMenu').classList.remove('active');
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Øµ Ø²Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    const actionText = document.getElementById('navActionText');
    if (actionText) {
        const defaultTexts = {
            ar: 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª',
            en: 'Actions',
            tr: 'Ä°ÅŸlemler'
        };
        actionText.textContent = defaultTexts[currentLang];
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const modelMenu = document.getElementById('modelActionMenu');
    if (modelMenu) {
        modelMenu.classList.remove('active');
        modelMenu.style.display = 'none';
    }
    
    window.scrollTo(0,0);
}


        /* ============================================================ */
        /* âœï¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ£Ø­Ø¬Ø§Ù… Ø§Ù„Ù†ØµÙˆØµ */
        /* ============================================================ */
        
        // Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ· Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
        function renderFontOptions() {
            const c = document.getElementById('fontOptionsContainer'); 
            c.innerHTML = '';
            const fonts = fontsDB[currentLang] || fontsDB['en'];
            const cur = localStorage.getItem(`appFont_${currentLang}`) || (currentLang === 'ar' ? 'Cairo' : 'Roboto');
            
            fonts.forEach(f => {
                const b = document.createElement('button'); 
                b.className = `font-btn ${cur === f.name ? 'active' : ''}`;
                b.style.fontFamily = f.name; 
                b.textContent = f.label; 
                b.onclick = () => setFontFamily(f.name); 
                c.appendChild(b);
            });
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ø®Ø· Ù…Ø¹ÙŠÙ†
        function setFontFamily(f) { 
            document.documentElement.style.setProperty('--app-font', `'${f}', sans-serif`); 
            localStorage.setItem(`appFont_${currentLang}`, f); 
            renderFontOptions(); 
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ø­Ø¬Ù… Ø§Ù„Ù†Øµ
        function setFontSize(s) { 
            document.documentElement.setAttribute('data-font-size', s); 
            localStorage.setItem('appFontSize', s); 
            document.querySelectorAll('.size-btn').forEach(b => { 
                b.classList.remove('active'); 
                if(b.dataset.size === s) b.classList.add('active'); 
            }); 
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        function loadPreferences() { 
            setFontSize(localStorage.getItem('appFontSize') || 'md'); 
        }

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        function resetApp() { 
            if(confirm('Reset App?')) { 
                localStorage.clear(); 
                location.reload(); 
            } 
        }

        // ØªØ³Ø¬ÙŠÙ„ Service Worker Ù„Ù„Ø¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„
        if ('serviceWorker' in navigator) { 
            window.addEventListener('load', () => { 
                navigator.serviceWorker.register('sw.js'); 
            }); 
        }

        /* ============================================================ */
        /* ğŸ­ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª (Materials Management) */
        /* ============================================================ */

        // Ù…ØªØºÙŠØ±Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        let db; // Ù…Ø±Ø¬Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const DB_NAME = 'FurnitureDB'; // Ø§Ø³Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const DB_VERSION = 1; // Ø¥ØµØ¯Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

        // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains('materials')) {
                        const store = db.createObjectStore('materials', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('category', 'category', { unique: false });
                    }
                };
                
                // Ù†Ø¬Ø­ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                request.onsuccess = (e) => { 
                    db = e.target.result; 
                    resolve(db); 
                    loadMaterials(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙÙˆØ± Ø§Ù„ÙØªØ­
                };
                
                // Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                request.onerror = (e) => reject('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            });
        }

        // ØªØ´ØºÙŠÙ„ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', () => {
            initDB();
            loadCurrencySettings(); // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø©
            loadConfigData(); // ØªØ­Ù…ÙŠÙ„ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª
        });

        /* ============================================================ */
        /* ğŸ’± Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù (Currency System) */
        /* ============================================================ */
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        let currencyConfig = {
            primary: 'USD',    // Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            secondary: 'TRY',  // Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©
            rate: 34.5,        // Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù
            auto: false        // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        };

        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        function loadCurrencySettings() {
            const saved = localStorage.getItem('currencyConfig');
            if(saved) currencyConfig = JSON.parse(saved);
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            const p = document.getElementById('currPrimary'); 
            if(p) p.value = currencyConfig.primary;
            
            const s = document.getElementById('currSecondary'); 
            if(s) s.value = currencyConfig.secondary;
            
            const r = document.getElementById('exchangeRateVal'); 
            if(r) r.value = currencyConfig.rate;
            
            const a = document.getElementById('autoRateToggle'); 
            if(a) a.checked = currencyConfig.auto;
            
            updateCurrencyLabels(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ³Ù…ÙŠØ§Øª
            if(currencyConfig.auto) fetchLiveRate(); // Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        }

        // ØªØ­Ø¯ÙŠØ« ØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        function updateCurrencyLabels() {
            // ØªØ­Ø¯ÙŠØ« ØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            const ids = ['rateFromLabel', 'primaryCurrLabel', 'primaryCurrLabelModal'];
            ids.forEach(id => { 
                const el = document.getElementById(id); 
                if(el) el.textContent = currencyConfig.primary; 
            });

            // ØªØ­Ø¯ÙŠØ« ØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©
            const ids2 = ['rateToLabel', 'secondaryCurrLabel', 'secondaryCurrLabelModal'];
            ids2.forEach(id => { 
                const el = document.getElementById(id); 
                if(el) el.textContent = currencyConfig.secondary; 
            });
            
            // ØªØ¹Ø·ÙŠÙ„/ØªÙØ¹ÙŠÙ„ Ø­Ù‚Ù„ Ø§Ù„Ø³Ø¹Ø± Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            const inputRate = document.getElementById('exchangeRateVal');
            if(inputRate) inputRate.disabled = currencyConfig.auto;
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
            const fetchBtn = document.getElementById('fetchRateBtn');
            if(fetchBtn) fetchBtn.style.display = currencyConfig.auto ? 'inline-block' : 'none';
        }

        // Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø©
        function saveCurrencySettings() {
            currencyConfig.primary = document.getElementById('currPrimary').value;
            currencyConfig.secondary = document.getElementById('currSecondary').value;
            currencyConfig.rate = parseFloat(document.getElementById('exchangeRateVal').value) || 1;
            currencyConfig.auto = document.getElementById('autoRateToggle').checked;
            
            localStorage.setItem('currencyConfig', JSON.stringify(currencyConfig));
            updateCurrencyLabels();
            if(currencyConfig.auto) fetchLiveRate(); // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ
            loadMaterials(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        function toggleAutoRate() { 
            saveCurrencySettings(); 
        }

        // Ø¬Ù„Ø¨ Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø­ÙŠ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
        async function fetchLiveRate() {
            if(!currencyConfig.auto) return;
            try {
                const res = await fetch(`https://api.exchangerate-api.com/v4/latest/${currencyConfig.primary}`);
                const data = await res.json();
                const rate = data.rates[currencyConfig.secondary];
                if(rate) {
                    currencyConfig.rate = rate;
                    document.getElementById('exchangeRateVal').value = rate;
                    localStorage.setItem('currencyConfig', JSON.stringify(currencyConfig));
                    loadMaterials(); // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯
                }
            } catch(e) { 
                console.log('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©', e); 
            }
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©
        function calculateSecondaryPrice() {
            const pPrice = parseFloat(document.getElementById('matPrice').value) || 0;
            const sPrice = (pPrice * currencyConfig.rate).toFixed(2);
            document.getElementById('secondaryPriceDisplay').textContent = sPrice;
        }

        /* ============================================================ */
        /* âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª (Categories & Units) */
        /* ============================================================ */
        
        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ØªØµÙ†ÙŠÙØ§Øª (3 Ù„ØºØ§Øª)
        const defaultCats = [
            { ar: 'Ø®Ø´Ø¨', en: 'Wood', tr: 'AhÅŸap' },
            { ar: 'Ù…Ø¹Ø¯Ù†', en: 'Metal', tr: 'Metal' },
            { ar: 'Ø§ÙƒØ³Ø³ÙˆØ§Ø±', en: 'Accessory', tr: 'Aksesuar' }
        ];

        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø§Øª (3 Ù„ØºØ§Øª)
        const defaultUnits = [
            { ar: 'Ù…ØªØ±', en: 'Meter', tr: 'Metre' },
            { ar: 'Ù‚Ø·Ø¹Ø©', en: 'Piece', tr: 'Adet' },
            { ar: 'ÙƒØº', en: 'Kg', tr: 'Kg' }
        ];

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        let categories = JSON.parse(localStorage.getItem('matCategoriesObj')) || defaultCats;
        let units = JSON.parse(localStorage.getItem('matUnitsObj')) || defaultUnits;

        let currentConfigType = ''; // Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: 'cat' Ø£Ùˆ 'unit'

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        function loadConfigData() {
            // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
            const fillSelect = (id, arr) => {
                const sel = document.getElementById(id); 
                if(!sel) return;
                sel.innerHTML = '';
                arr.forEach((item, index) => {
                    const opt = document.createElement('option');
                    opt.value = index; // Ø§Ù„ÙÙ‡Ø±Ø³ ÙƒÙ…Ø¹Ø±Ù
                    opt.textContent = item[currentLang] || item.ar; // Ø§Ù„Ù†Øµ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
                    sel.appendChild(opt);
                });
            };
            fillSelect('matCategory', categories);
            fillSelect('matUnit', units);
        }

        // ÙØªØ­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
        function manageCategories() { 
            openConfigModal('cat'); 
        }

        // ÙØªØ­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª
        function manageUnits() { 
            openConfigModal('unit'); 
        }

        // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        function openConfigModal(type) {
            currentConfigType = type;
            const modal = document.getElementById('configModal');
            modal.style.display = 'flex';
            
            // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updateModalUITexts('configModal');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            const titleEl = document.getElementById('configTitle');
            const titles = {
                cat: { ar: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª', en: 'Manage Categories', tr: 'Kategori YÃ¶netimi' },
                unit: { ar: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª', en: 'Manage Units', tr: 'Birim YÃ¶netimi' }
            };
            titleEl.textContent = titles[type][currentLang];

            renderConfigList(); // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        }

        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        function renderConfigList() {
            const list = document.getElementById('configList'); 
            list.innerHTML = '';
            const arr = currentConfigType === 'cat' ? categories : units;
            
            arr.forEach((item, index) => {
                const li = document.createElement('li'); 
                li.className = 'config-item';
                // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„ØºØ§Øª
                li.innerHTML = `
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight:bold;">${item[currentLang] || item.ar}</span>
                        <span style="font-size:0.75rem; color:#888;">${item.ar} | ${item.en} | ${item.tr}</span>
                    </div>
                    <span class="del-btn-small" onclick="deleteConfigItem(${index})">ğŸ—‘ï¸</span>
                `;
                list.appendChild(li);
            });
        }

        // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯
        function addConfigItem() {
            const ar = document.getElementById('confAr').value.trim();
            const en = document.getElementById('confEn').value.trim();
            const tr = document.getElementById('confTr').value.trim();

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
            if(!ar || !en || !tr) { 
                alert(currentLang==='ar'?'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„ØºØ§Øª Ø§Ù„Ø«Ù„Ø§Ø«': 'Please fill all 3 languages'); 
                return; 
            }

            const newItem = { ar, en, tr };

            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆØ­ÙØ¸Ù‡Ø§
            if(currentConfigType === 'cat') { 
                categories.push(newItem); 
                localStorage.setItem('matCategoriesObj', JSON.stringify(categories)); 
            } else { 
                units.push(newItem); 
                localStorage.setItem('matUnitsObj', JSON.stringify(units)); 
            }

            // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('confAr').value = '';
            document.getElementById('confEn').value = '';
            document.getElementById('confTr').value = '';
            
            renderConfigList(); 
            loadConfigData(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        }

        // Ø­Ø°Ù Ø¹Ù†ØµØ±
        function deleteConfigItem(index) {
            if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) return;
            
            if(currentConfigType === 'cat') { 
                categories.splice(index, 1); 
                localStorage.setItem('matCategoriesObj', JSON.stringify(categories)); 
            } else { 
                units.splice(index, 1); 
                localStorage.setItem('matUnitsObj', JSON.stringify(units)); 
            }
            renderConfigList(); 
            loadConfigData();
        }

        /* ============================================================ */
        /* ğŸ“¸ Ø¶ØºØ· ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ± (Image Optimization) */
        /* ============================================================ */
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù…Ø¹ Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†
        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø£Ù‚ØµÙ‰ Ø¹Ø±Ø¶ 800 Ø¨ÙƒØ³Ù„)
                        const maxWidth = 800;
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        
                        // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ø­Ø¬Ù… Ù…Ù†Ø§Ø³Ø¨
                        let quality = 0.7;
                        let dataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø­ØªÙ‰ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø­Ø¬Ù… Ø£Ù‚Ù„ Ù…Ù† 60KB
                        while(dataUrl.length > 60000 && quality > 0.1) {
                            quality -= 0.1;
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                        }
                        
                        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø©
                        document.getElementById('matPreview').src = dataUrl;
                        document.getElementById('matPreview').style.display = 'block';
                        document.getElementById('matUploadPlaceholder').style.display = 'none';
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        /* ============================================================ */
        /* ğŸ“ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ§Ø¯ (CRUD Operations) */
        /* ============================================================ */

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function updateModalUITexts(modalId) {
            const modal = document.getElementById(modalId);
            if(!modal) return;
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†ØµÙˆØµ Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù„ØºØ§Øª
            modal.querySelectorAll('[data-ar]').forEach(el => {
                const txt = el.getAttribute(`data-${currentLang}`) || el.getAttribute('data-ar');
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ±Ø¹ÙŠØ©
                if(el.children.length > 0) {
                    el.textContent = txt; 
                } else {
                    el.textContent = txt;
                }
            });
        }

        // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø©
        function openMaterialModal(id = null) {
            const modal = document.getElementById('materialModal');
            modal.style.display = 'flex';
            
            // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updateModalUITexts('materialModal');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            const titleEl = document.getElementById('matModalTitle');
            const titleText = id ? 
                (currentLang=='ar'?'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø©':'Edit Material') : 
                (currentLang=='ar'?'Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©':'New Material');
            if(currentLang=='tr') titleEl.textContent = id ? 'Malzeme DÃ¼zenle' : 'Yeni Malzeme';
            else titleEl.textContent = titleText;

            // ØªØ­Ø¯ÙŠØ« ØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø©
            document.getElementById('matId').value = id || '';
            document.getElementById('primaryCurrLabelModal').textContent = currencyConfig.primary;
            document.getElementById('secondaryCurrLabelModal').textContent = currencyConfig.secondary;

            if(id) {
                // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ - Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø©
                const transaction = db.transaction(['materials'], 'readonly');
                const store = transaction.objectStore('materials');
                const request = store.get(Number(id));
                
                request.onsuccess = (e) => {
                    const mat = e.target.result;
                    
                    // Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
                    document.getElementById('matNameAr').value = mat.name.ar || mat.name;
                    document.getElementById('matNameEn').value = mat.name.en || '';
                    document.getElementById('matNameTr').value = mat.name.tr || '';
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠÙ ÙˆØ§Ù„ÙˆØ­Ø¯Ø©
                    const catIdx = categories.findIndex(c => c.ar === (mat.category.ar || mat.category));
                    if(catIdx > -1) document.getElementById('matCategory').value = catIdx;
                    
                    const unitIdx = units.findIndex(u => u.ar === (mat.unit.ar || mat.unit));
                    if(unitIdx > -1) document.getElementById('matUnit').value = unitIdx;

                    // Ù…Ù„Ø¡ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„ØµÙˆØ±Ø©
                    document.getElementById('matPrice').value = mat.price;
                    document.getElementById('btnDeleteMat').style.display = 'block';
                    
                    if(mat.image) {
                        document.getElementById('matPreview').src = mat.image;
                        document.getElementById('matPreview').style.display = 'block';
                        document.getElementById('matUploadPlaceholder').style.display = 'none';
                    }
                    calculateSecondaryPrice();
                };
            } else {
                // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ© - ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('matNameAr').value = '';
                document.getElementById('matNameEn').value = '';
                document.getElementById('matNameTr').value = '';
                document.getElementById('matPrice').value = '';
                document.getElementById('matPreview').src = '';
                document.getElementById('matPreview').style.display = 'none';
                document.getElementById('matUploadPlaceholder').style.display = 'block';
                document.getElementById('btnDeleteMat').style.display = 'none';
                document.getElementById('secondaryPriceDisplay').textContent = '0';
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø§Ø¯Ø©
        function closeMatModal() { 
            document.getElementById('materialModal').style.display = 'none'; 
        }

        // Ø­ÙØ¸ Ø§Ù„Ù…Ø§Ø¯Ø© (Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„)
        function saveMaterial() {
            // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø¹ ØªØ¹Ù‚ÙŠÙ… Ø§Ù„Ù†ØµÙˆØµ
            const nameAr = sanitizeText(document.getElementById('matNameAr').value);
            const nameEn = sanitizeText(document.getElementById('matNameEn').value);
            const nameTr = sanitizeText(document.getElementById('matNameTr').value);
            
            // Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ ÙˆØ§Ù„ÙˆØ­Ø¯Ø©
            const catIndex = document.getElementById('matCategory').value;
            const unitIndex = document.getElementById('matUnit').value;
            
            const categoryObj = categories[catIndex];
            const unitObj = units[unitIndex];

            const price = parseFloat(document.getElementById('matPrice').value);
            const image = document.getElementById('matPreview').src;
            const id = document.getElementById('matId').value;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if(!nameAr || !nameEn || !nameTr) { 
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø§Ø³Ù… Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„ØºØ§Øª'); 
                return; 
            }

            // ØªÙƒÙˆÙŠÙ† ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø§Ø¯Ø©
            const item = { 
                name: { ar: nameAr, en: nameEn, tr: nameTr }, 
                category: categoryObj, // Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ø¦Ù† ÙƒØ§Ù…Ù„Ø§Ù‹
                unit: unitObj,         // Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ø¦Ù† ÙƒØ§Ù…Ù„Ø§Ù‹
                price, 
                image: image.includes('data:image') ? image : '' 
            };

            // Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const transaction = db.transaction(['materials'], 'readwrite');
            const store = transaction.objectStore('materials');

            if(id) {
                // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
                item.id = Number(id);
                store.put(item);
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
                store.add(item);
            }

            transaction.oncomplete = () => { 
                closeMatModal(); 
                loadMaterials(); 
            };
        }

        // Ø­Ø°Ù Ù…Ø§Ø¯Ø©
        function deleteMaterial() {
            const id = Number(document.getElementById('matId').value);
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
                const transaction = db.transaction(['materials'], 'readwrite');
                transaction.objectStore('materials').delete(id);
                transaction.oncomplete = () => { 
                    closeMatModal(); 
                    loadMaterials(); 
                };
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ¹Ù‚ÙŠÙ… Ø§Ù„Ù†ØµÙˆØµ Ù„Ù…Ù†Ø¹ ØªÙ†ÙÙŠØ° Ø£ÙƒÙˆØ§Ø¯ Ø¶Ø§Ø±Ø©
        function sanitizeText(text) {
            if (!text) return '';
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø¶Ø§Ø±Ø© ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø®Ø§ØµØ©
            return text.replace(/[<>\"'&]/g, function(match) {
                const escapeMap = {
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;',
                    '&': '&amp;'
                };
                return escapeMap[match];
            }).trim();
        }

        /* ============================================================ */
        /* ğŸ“Š Ø¹Ø±Ø¶ ÙˆØ¨Ø­Ø« Ø§Ù„Ù…ÙˆØ§Ø¯ (Display & Search) */
        /* ============================================================ */
        
        let allMaterials = []; // Ù…ØµÙÙˆÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯
        let searchTimeout; // Ù…ØªØºÙŠØ± Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø«

        // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function loadMaterials() {
            if(!db) return;
            const transaction = db.transaction(['materials'], 'readonly');
            const store = transaction.objectStore('materials');
            const request = store.getAll();

            request.onsuccess = (e) => {
                allMaterials = e.target.result;
                renderMaterials(allMaterials);
            };
        }

        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ø¬Ù…Ø¹Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ
        function renderMaterials(list) {
            const container = document.getElementById('materialsList');
            container.innerHTML = '';

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ
            const grouped = {};
            list.forEach(m => {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø­Ø³Ø¨ Ù„ØºØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                let catName = 'ØºÙŠØ± Ù…ØµÙ†Ù';
                if(m.category && typeof m.category === 'object') {
                    catName = m.category[currentLang] || m.category.ar;
                } else {
                    catName = m.category; // Ø¯Ø¹Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                }
                
                if(!grouped[catName]) grouped[catName] = [];
                grouped[catName].push(m);
            });

            // Ø¹Ø±Ø¶ ÙƒÙ„ ØªØµÙ†ÙŠÙ ÙˆÙ…ÙˆØ§Ø¯Ù‡
            for (const [cat, items] of Object.entries(grouped)) {
                // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØµÙ†ÙŠÙ
                const header = document.createElement('div');
                header.className = 'category-header';
                header.innerHTML = `<span>${cat}</span> <span style="font-size:0.8rem; opacity:0.7;">${items.length}</span>`;
                container.appendChild(header);

                // Ø¹Ø±Ø¶ Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØµÙ†ÙŠÙ
                items.forEach(m => {
                    const sPrice = (m.price * currencyConfig.rate).toFixed(2);
                    
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØµÙˆØµ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    let dName = m.name;
                    if(typeof m.name === 'object') dName = m.name[currentLang] || m.name.ar;
                    
                    let dUnit = m.unit;
                    if(typeof m.unit === 'object') dUnit = m.unit[currentLang] || m.unit.ar;

                    // Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø§Ø¯Ø©
                    const card = document.createElement('div');
                    card.className = 'material-card';
                    card.onclick = () => openMaterialModal(m.id);
                    card.innerHTML = `
                        <img src="${m.image || 'https://via.placeholder.com/60?text=Img'}" class="mat-thumb">
                        <div class="mat-info">
                            <div class="mat-name">${dName}</div>
                            <div class="mat-unit">${dUnit}</div>
                        </div>
                        <div style="text-align:left;">
                            <div class="mat-price">${m.price} <small>${currencyConfig.primary}</small></div>
                            <div style="font-size:0.75rem; color:#888;">${sPrice} <small>${currencyConfig.secondary}</small></div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
            
            // Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ§Ø¯
            if(list.length === 0) {
                container.innerHTML = '<div class="empty-content">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ / No Materials</div>';
            }
        }

        // Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ ØªÙ‚Ù†ÙŠØ© Debounce Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
        function debouncedSearch() {
            // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            clearTimeout(searchTimeout);
            
            // ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ù„Ù…Ø¯Ø© 300 Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ©
            searchTimeout = setTimeout(() => {
                filterMaterials();
            }, 300);
        }

        // ØªØµÙÙŠØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø­Ø³Ø¨ Ù†Øµ Ø§Ù„Ø¨Ø­Ø«
        function filterMaterials() {
            const q = document.getElementById('matSearch').value.toLowerCase();
            
            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„ØºØ§Øª
            const filtered = allMaterials.filter(m => {
                // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø§Ø³Ù…
                let nameMatch = false;
                if(typeof m.name === 'object') {
                    nameMatch = (m.name.ar && m.name.ar.toLowerCase().includes(q)) || 
                                (m.name.en && m.name.en.toLowerCase().includes(q)) || 
                                (m.name.tr && m.name.tr.toLowerCase().includes(q));
                } else {
                    nameMatch = m.name.toLowerCase().includes(q);
                }

                // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØªØµÙ†ÙŠÙ
                let catMatch = false;
                if(typeof m.category === 'object') {
                    catMatch = (m.category.ar && m.category.ar.toLowerCase().includes(q)) ||
                               (m.category.en && m.category.en.toLowerCase().includes(q)) ||
                               (m.category.tr && m.category.tr.toLowerCase().includes(q));
                } else {
                    catMatch = m.category.toLowerCase().includes(q);
                }
                
                return nameMatch || catMatch;
            });
            
            renderMaterials(filtered);
        }

        /* ============================================================ */
        /* ğŸ–¨ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠ (Smart Printing System) */
        /* ============================================================ */

        let selectedPrintType = 'all'; // Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØªØ§Ø±

        // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        function showPrintOptions() {
            const modal = document.getElementById('printModal');
            const searchVal = document.getElementById('matSearch').value.trim();
            
            // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø®ÙŠØ§Ø± Ø·Ø¨Ø§Ø¹Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
            const searchBtn = document.getElementById('optSearch');
            if(!searchVal) {
                searchBtn.classList.add('disabled');
                if(selectedPrintType === 'search') {
                    selectPrintType(document.querySelector('.print-card'), 'all');
                }
            } else {
                searchBtn.classList.remove('disabled');
            }

            // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
            const catSel = document.getElementById('printCatSelect');
            catSel.innerHTML = `<option value="all_cats">${currentLang=='ar'?'ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª':'All Categories'}</option>`;
            categories.forEach((c, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = c[currentLang] || c.ar;
                catSel.appendChild(opt);
            });

            // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„Ù†Ø§ÙØ°Ø©
            modal.querySelectorAll('[data-ar]').forEach(el => {
                el.textContent = el.getAttribute(`data-${currentLang}`) || el.getAttribute('data-ar');
            });

            modal.style.display = 'flex';
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        function selectPrintType(el, type) {
            document.querySelectorAll('.print-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            selectedPrintType = type;

            // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
            document.getElementById('printCatSelectWrapper').style.display = (type === 'cat') ? 'block' : 'none';
        }

        // ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        function executePrint() {
            document.getElementById('printModal').style.display = 'none';

            // Ø¬Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            const printLang = document.getElementById('printLangSelect').value;
            const includeImg = document.getElementById('printIncImg').checked;
            const catFilterVal = document.getElementById('printCatSelect').value;

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§
            let listToPrint = allMaterials;

            if (selectedPrintType === 'search') {
                // Ø·Ø¨Ø§Ø¹Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
                const q = document.getElementById('matSearch').value.toLowerCase();
                listToPrint = allMaterials.filter(m => {
                    const n = m.name; 
                    const c = m.category;
                    const txt = JSON.stringify(n) + JSON.stringify(c);
                    return txt.toLowerCase().includes(q);
                });
            } 
            else if (selectedPrintType === 'cat') {
                // Ø·Ø¨Ø§Ø¹Ø© ØªØµÙ†ÙŠÙ Ù…Ø­Ø¯Ø¯
                if(catFilterVal !== 'all_cats') {
                    const selectedCatObj = categories[catFilterVal];
                    listToPrint = allMaterials.filter(m => {
                        const mCatAr = m.category.ar || m.category; 
                        return mCatAr === selectedCatObj.ar;
                    });
                }
            }

            // ØªØ­Ø¯ÙŠØ¯ Ù„ØºØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            const targetLang = (printLang === 'current') ? currentLang : printLang; 

            generatePrintHTML(listToPrint, targetLang, includeImg);
        }

              // ØªÙˆÙ„ÙŠØ¯ HTML Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
        function generatePrintHTML(data, langMode, withImg) {
            // Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
            const getText = (obj) => {
                if (typeof obj !== 'object') return obj; // Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                
                if (langMode === 'all') {
                    // Ø¹Ø±Ø¶ Ù…ÙƒØ¯Ø³ Ù„Ù„ØºØ§Øª Ø§Ù„Ø«Ù„Ø§Ø«
                    return `
                        <div class="txt-ar">${obj.ar}</div>
                        <div class="txt-en">${obj.en}</div>
                        <div class="txt-tr">${obj.tr}</div>
                    `;
                } else {
                    // Ø¹Ø±Ø¶ Ù„ØºØ© ÙˆØ§Ø­Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø©
                    return obj[langMode] || obj.ar;
                }
            };

            // Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            const headers = {
                ar: { title:'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¯', name:'Ø§Ù„Ù…Ø§Ø¯Ø©', cat:'Ø§Ù„ØªØµÙ†ÙŠÙ', unit:'Ø§Ù„ÙˆØ­Ø¯Ø©', price:'Ø§Ù„Ø³Ø¹Ø±' },
                en: { title:'Materials Report', name:'Material', cat:'Category', unit:'Unit', price:'Price' },
                tr: { title:'Malzeme Raporu', name:'Malzeme', cat:'Kategori', unit:'Birim', price:'Fiyat' },
                all: { 
                    title: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¯ / Materials Report', 
                    name: '<span class="th-ar">Ø§Ù„Ù…Ø§Ø¯Ø©</span><br><span class="th-en">Material</span>',
                    cat: '<span class="th-ar">Ø§Ù„ØªØµÙ†ÙŠÙ</span><br><span class="th-en">Category</span>',
                    unit: '<span class="th-ar">Ø§Ù„ÙˆØ­Ø¯Ø©</span><br><span class="th-en">Unit</span>',
                    price: '<span class="th-ar">Ø§Ù„Ø³Ø¹Ø±</span><br><span class="th-en">Price</span>'
                }
            };
            
            const H = headers[langMode] || headers.ar;
            const isMulti = langMode === 'all';

            // Ø¨Ù†Ø§Ø¡ HTML Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            let html = `
            <html>
            <head>
                <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</title>
                <style>
                    body { 
                        font-family: 'Segoe UI', Tahoma, sans-serif; 
                        padding: 20px; 
                        direction: ${langMode==='ar'?'rtl':'ltr'}; 
                        color: #333;
                    }
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin-top: 20px; 
                        font-size: 14px; 
                    }
                    th, td { 
                        border: 1px solid #ccc; 
                        padding: 8px; 
                        text-align: center; 
                        vertical-align: middle; 
                    }
                    th { 
                        background: #f4f4f4; 
                        color: #333; 
                        font-weight: bold;
                    }
                    .header { 
                        text-align: center; 
                        margin-bottom: 20px; 
                        border-bottom: 2px solid #333; 
                        padding-bottom: 10px; 
                    }
                    
                    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø§Ù…Ù„ */
                    .txt-ar { 
                        font-weight: bold; 
                        font-size: 1.1em; 
                        color: #000; 
                    }
                    .txt-en { 
                        font-size: 0.9em; 
                        color: #555; 
                    }
                    .txt-tr { 
                        font-size: 0.85em; 
                        color: #777; 
                        font-style: italic; 
                    }
                    .th-ar { 
                        font-weight: bold; 
                    } 
                    .th-en { 
                        font-size: 0.8em; 
                        font-weight: normal; 
                    }
                    
                    img { 
                        width: 50px; 
                        height: 50px; 
                        object-fit: cover; 
                        border-radius: 4px; 
                    }
                    
                    @media print {
                        body { margin: 0; }
                        .header { page-break-after: avoid; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h2>${H.title}</h2>
                    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯: ${data.length} | Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            ${withImg ? '<th width="10%">ØµÙˆØ±Ø©</th>' : ''}
                            <th>${H.name}</th>
                            <th>${H.cat}</th>
                            <th>${H.unit}</th>
                            <th>${H.price}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Ø¥Ø¶Ø§ÙØ© ØµÙÙˆÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            data.forEach((m, i) => {
                const sPrice = (m.price * currencyConfig.rate).toFixed(2);
                const imgTag = m.image ? `<img src="${m.image}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø¯Ø©">` : '-';

                html += `<tr>
                    <td>${i+1}</td>
                    ${withImg ? `<td>${imgTag}</td>` : ''}
                    <td style="text-align:${isMulti?'center':'start'}">${getText(m.name)}</td>
                    <td>${getText(m.category)}</td>
                    <td>${getText(m.unit)}</td>
                    <td>
                        <b>${m.price}</b> <small>${currencyConfig.primary}</small><br>
                        <span style="color:#666; font-size:0.9em;">${sPrice} ${currencyConfig.secondary}</span>
                    </td>
                </tr>`;
            });

            html += `
                    </tbody>
                </table>
                <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                    ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„
                </div>
            </body>
            </html>`;

            // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
            const win = window.open('', '', 'width=900,height=700');
            win.document.write(html);
            win.document.close();
            
            // Ø·Ø¨Ø§Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
            if(withImg) {
                win.onload = () => { 
                    win.focus(); 
                    win.print(); 
                };
            } else {
                setTimeout(() => {
                    win.focus();
                    win.print();
                }, 500);
            }
        }

        /* ============================================================ */
        /* ğŸ”§ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ© (Helper Functions) */
        /* ============================================================ */

        // ØªØ­Ø³ÙŠÙ† ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙˆØ± ÙƒÙ€ Blob ÙÙŠ IndexedDB
        function convertImageToBlob(dataUrl) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/jpeg', 0.8);
                };
                
                img.src = dataUrl;
            });
        }

        // ØªØ­ÙˆÙŠÙ„ Blob Ø¥Ù„Ù‰ URL Ù„Ù„Ø¹Ø±Ø¶
        function createImageURL(blob) {
            if (blob) {
                return URL.createObjectURL(blob);
            }
            return null;
        }

        // ØªÙ†Ø¸ÙŠÙ URLs Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        function cleanupImageURL(url) {
            if (url && url.startsWith('blob:')) {
                URL.revokeObjectURL(url);
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function validateMaterialData(data) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø§Ø³Ù… Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„ØºØ§Øª
            if (!data.name || !data.name.ar || !data.name.en || !data.name.tr) {
                return { valid: false, message: 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„ØºØ§Øª' };
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø³Ø¹Ø±
            if (!data.price || data.price <= 0) {
                return { valid: false, message: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ØµØ­ÙŠØ­' };
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØªØµÙ†ÙŠÙ ÙˆØ§Ù„ÙˆØ­Ø¯Ø©
            if (!data.category || !data.unit) {
                return { valid: false, message: 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØµÙ†ÙŠÙ ÙˆØ§Ù„ÙˆØ­Ø¯Ø©' };
            }

            return { valid: true };
        }

        // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
        function exportMaterialsData() {
            if (!allMaterials.length) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            const dataStr = JSON.stringify({
                materials: allMaterials,
                categories: categories,
                units: units,
                currencyConfig: currencyConfig,
                exportDate: new Date().toISOString()
            }, null, 2);

            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `materials_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        // Ø¯Ø§Ù„Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function importMaterialsData(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.materials && Array.isArray(data.materials)) {
                        // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
                        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
                            // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯
                            const transaction = db.transaction(['materials'], 'readwrite');
                            const store = transaction.objectStore('materials');
                            
                            // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                            store.clear();
                            
                            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                            data.materials.forEach(material => {
                                delete material.id; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø±Ù Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯
                                store.add(material);
                            });
                            
                            transaction.oncomplete = () => {
                                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª
                                if (data.categories) {
                                    categories = data.categories;
                                    localStorage.setItem('matCategoriesObj', JSON.stringify(categories));
                                }
                                
                                if (data.units) {
                                    units = data.units;
                                    localStorage.setItem('matUnitsObj', JSON.stringify(units));
                                }
                                
                                // ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø©
                                if (data.currencyConfig) {
                                    currencyConfig = data.currencyConfig;
                                    localStorage.setItem('currencyConfig', JSON.stringify(currencyConfig));
                                    loadCurrencySettings();
                                }
                                
                                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                loadConfigData();
                                loadMaterials();
                                
                                alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                            };
                        }
                    } else {
                        alert('Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­');
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
        function advancedSearch(query, filters = {}) {
            return allMaterials.filter(material => {
                let matches = true;
                
                // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
                if (query) {
                    const searchText = query.toLowerCase();
                    const nameMatch = Object.values(material.name).some(name => 
                        name.toLowerCase().includes(searchText)
                    );
                    const categoryMatch = Object.values(material.category).some(cat => 
                        cat.toLowerCase().includes(searchText)
                    );
                    matches = matches && (nameMatch || categoryMatch);
                }
                
                // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ
                if (filters.category) {
                    matches = matches && (material.category.ar === filters.category);
                }
                
                // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±
                if (filters.minPrice !== undefined) {
                    matches = matches && (material.price >= filters.minPrice);
                }
                if (filters.maxPrice !== undefined) {
                    matches = matches && (material.price <= filters.maxPrice);
                }
                
                return matches;
            });
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ§Ø¯
        function getMaterialsStats() {
            const stats = {
                totalMaterials: allMaterials.length,
                categoriesCount: {},
                averagePrice: 0,
                totalValue: 0,
                priceRange: { min: Infinity, max: -Infinity }
            };
            
            if (allMaterials.length === 0) return stats;
            
            let totalPrice = 0;
            
            allMaterials.forEach(material => {
                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
                const catName = material.category.ar || material.category;
                stats.categoriesCount[catName] = (stats.categoriesCount[catName] || 0) + 1;
                
                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
                totalPrice += material.price;
                stats.totalValue += material.price;
                
                if (material.price < stats.priceRange.min) {
                    stats.priceRange.min = material.price;
                }
                if (material.price > stats.priceRange.max) {
                    stats.priceRange.max = material.price;
                }
            });
            
            stats.averagePrice = totalPrice / allMaterials.length;
            
            return stats;
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function showMaterialsStats() {
            const stats = getMaterialsStats();
            
            let message = `ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ§Ø¯:\n\n`;
            message += `â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯: ${stats.totalMaterials}\n`;
            message += `â€¢ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø±: ${stats.averagePrice.toFixed(2)} ${currencyConfig.primary}\n`;
            message += `â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©: ${stats.totalValue.toFixed(2)} ${currencyConfig.primary}\n`;
            
            if (stats.totalMaterials > 0) {
                message += `â€¢ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±: ${stats.priceRange.min} - ${stats.priceRange.max} ${currencyConfig.primary}\n\n`;
                message += `ğŸ“‚ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ:\n`;
                
                Object.entries(stats.categoriesCount).forEach(([category, count]) => {
                    message += `â€¢ ${category}: ${count} Ù…Ø§Ø¯Ø©\n`;
                });
            }
            
            alert(message);
        }

        // ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Workers (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        function createSearchWorker() {
            const workerCode = `
                self.onmessage = function(e) {
                    const { materials, query, filters } = e.data;
                    
                    const results = materials.filter(material => {
                        let matches = true;
                        
                        if (query) {
                            const searchText = query.toLowerCase();
                            const nameMatch = Object.values(material.name).some(name => 
                                name.toLowerCase().includes(searchText)
                            );
                            const categoryMatch = Object.values(material.category).some(cat => 
                                cat.toLowerCase().includes(searchText)
                            );
                            matches = matches && (nameMatch || categoryMatch);
                        }
                        
                        return matches;
                    });
                    
                    self.postMessage(results);
                };
            `;
            
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            return new Worker(URL.createObjectURL(blob));
        }

        /* ============================================================ */
        /* ğŸ¯ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø© */
        /* ============================================================ */

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        window.addEventListener('beforeunload', () => {
            // ØªÙ†Ø¸ÙŠÙ URLs Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„Ù„ØµÙˆØ±
            allMaterials.forEach(material => {
                if (material.imageURL) {
                    cleanupImageURL(material.imageURL);
                }
            });
            
            // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (db) {
                db.close();
            }
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        function checkMemoryUsage() {
            if ('memory' in performance) {
                const memInfo = performance.memory;
                const usedMB = Math.round(memInfo.usedJSHeapSize / 1048576);
                const totalMB = Math.round(memInfo.totalJSHeapSize / 1048576);
                
                console.log(`Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø©: ${usedMB}MB / ${totalMB}MB`);
                
                // ØªØ­Ø°ÙŠØ± Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø°Ø§ÙƒØ±Ø© Ù…Ø±ØªÙØ¹
                if (usedMB > 100) {
                    console.warn('Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø°Ø§ÙƒØ±Ø© Ù…Ø±ØªÙØ¹ - ÙŠÙÙ†ØµØ­ Ø¨ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±');
                }
            }
        }

        // ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±
        if (window.location.hostname === 'localhost') {
            setInterval(checkMemoryUsage, 30000);
        }

        /* ============================================================ */
        /* ğŸ”„ ØªØ­Ø¯ÙŠØ«Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙˆØªØ²Ø§Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
        /* ============================================================ */

        // ÙØ­Øµ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
        function checkForUpdates() {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ command: 'checkForUpdates' });
            }
        }

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data.type === 'UPDATE_AVAILABLE') {
                    if (confirm('ÙŠØªÙˆÙØ± ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ')) {
                        window.location.reload();
                    }
                }
            });
        }

        // ØªØ²Ø§Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… (Ø¥Ø°Ø§ ØªÙˆÙØ±)
        async function syncDataWithServer() {
            try {
                // Ù‡Ø°Ù‡ Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù…Ø¹ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ
                const response = await fetch('/api/materials/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        materials: allMaterials,
                        lastSync: localStorage.getItem('lastSyncTime')
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('lastSyncTime', new Date().toISOString());
                    console.log('ØªÙ… ØªØ²Ø§Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                }
            } catch (error) {
                console.log('Ø§Ù„ØªØ²Ø§Ù…Ù† ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹');
            }
        }





/* ============================================================ */
/* ğŸ›‹ï¸ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª (Models Management System) */
/* ============================================================ */

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
let allModels = [];
let selectedModelMaterials = [];
let modelSearchTimeout;
let selectedModelPrintType = 'all';

// Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
const defaultModelTypes = [
    { ar: 'Ù…Ø·Ø¨Ø®', en: 'Kitchen', tr: 'Mutfak' },
    { ar: 'ØºØ±ÙØ© Ù†ÙˆÙ…', en: 'Bedroom', tr: 'Yatak OdasÄ±' },
    { ar: 'ØµØ§Ù„ÙˆÙ†', en: 'Living Room', tr: 'Oturma OdasÄ±' }
];

let modelTypes = JSON.parse(localStorage.getItem('modelTypesObj')) || defaultModelTypes;

// ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
function initModelsDB() {
    if (!db) return;
    
    const transaction = db.transaction(['materials'], 'readwrite');
    const store = transaction.objectStore('materials');
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (!db.objectStoreNames.contains('models')) {
        const version = db.version + 1;
        db.close();
        
        const request = indexedDB.open(DB_NAME, version);
        request.onupgradeneeded = (e) => {
            const newDb = e.target.result;
            if (!newDb.objectStoreNames.contains('models')) {
                const modelStore = newDb.createObjectStore('models', { keyPath: 'id', autoIncrement: true });
                modelStore.createIndex('type', 'type', { unique: false });
                modelStore.createIndex('name', 'name', { unique: false });
            }
        };
        
        request.onsuccess = (e) => {
            db = e.target.result;
            loadModels();
        };
    }
}

// ÙØªØ­ Ù‚Ø³Ù… Ù…Ø¹ÙŠÙ†
function openSection(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    document.getElementById('matActionMenu').classList.remove('active');
    document.getElementById('matActionMenu').style.display = 'none';
    
    // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const modelMenu = document.getElementById('modelActionMenu');
    if (modelMenu) {
        modelMenu.classList.remove('active');
        modelMenu.style.display = 'none';
    }

    const s = sectionsDB.find(x => x.id === id);
    const t = document.getElementById('headerTitle'); 
    const i = document.getElementById('headerIcon');
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
    t.setAttribute('data-ar', s.ar); 
    t.setAttribute('data-tr', s.tr); 
    t.setAttribute('data-en', s.en);
    t.textContent = s[currentLang]; 
    i.textContent = s.icon;

    // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ
    const settingsBtn = document.getElementById('navSettingsBtn');
    const materialsBtn = document.getElementById('navMaterialsBtn');
    const actionText = document.getElementById('navActionText');

    if (id === 2) { 
        // Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª
        document.getElementById('materialsPage').classList.add('active');
        if(typeof loadMaterials === 'function') loadMaterials();
        
        settingsBtn.style.display = 'none';
        materialsBtn.style.display = 'flex';
        
        // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø²Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª
        if (actionText) {
            const materialTexts = {
                ar: 'Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª',
                en: 'Materials',
                tr: 'Malzemeler'
            };
            actionText.textContent = materialTexts[currentLang];
        }
    } 
    else if (id === 3) {
        // Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
        document.getElementById('modelsPage').classList.add('active');
        if(typeof initModelsDB === 'function') initModelsDB();
        if(typeof loadModels === 'function') loadModels();
        if(typeof loadModelTypesData === 'function') loadModelTypesData();
        
        settingsBtn.style.display = 'none';
        materialsBtn.style.display = 'flex';
        
        // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø²Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
        if (actionText) {
            const modelTexts = {
                ar: 'Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª',
                en: 'Models',
                tr: 'Modeller'
            };
            actionText.textContent = modelTexts[currentLang];
        }
    }
    else {
        // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰
        settingsBtn.style.display = 'flex';
        materialsBtn.style.display = 'none';

        if(id === 12) {
            // ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            document.getElementById('settingsPage').classList.add('active');
        } else {
            // ØµÙØ­Ø© Ù‚Ø³Ù… Ø¹Ø§Ù…
            document.getElementById('secTitle').textContent = s[currentLang];
            document.getElementById('secIcon').textContent = s.icon;
            document.getElementById('sectionPage').classList.add('active');
        }
    }
    window.scrollTo(0,0);
}

// ØªØ¨Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª - Ù…Ø­Ø¯Ø« Ù„Ø­Ù„ Ø§Ù„ØªØ¶Ø§Ø±Ø¨
function toggleMatMenu() {
    const currentPage = document.querySelector('.page.active');
    if (!currentPage) return;
    
    const pageId = currentPage.id;
    
    if (pageId === 'modelsPage') {
        toggleModelMenu();
    } else if (pageId === 'materialsPage') {
        toggleMaterialMenu();
    }
}

// Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯
function toggleMaterialMenu() {
    const menu = document.getElementById('matActionMenu');
    if (menu.classList.contains('active')) {
        menu.classList.remove('active');
        setTimeout(() => menu.style.display = 'none', 200);
    } else {
        menu.style.display = 'flex';
        setTimeout(() => menu.classList.add('active'), 10);
    }
}

// Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
function toggleModelMenu() {
    let modelMenu = document.getElementById('modelActionMenu');
    if (!modelMenu) {
        modelMenu = document.createElement('div');
        modelMenu.id = 'modelActionMenu';
        modelMenu.className = 'action-menu';
        modelMenu.style.bottom = '90px';
        document.body.appendChild(modelMenu);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØµØ­ÙŠØ­Ø©
    const addTexts = {
        ar: 'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„',
        en: 'Add Model', 
        tr: 'Model Ekle'
    };
    
    const printTexts = {
        ar: 'Ø·Ø¨Ø§Ø¹Ø©',
        en: 'Print',
        tr: 'YazdÄ±r'
    };
    
    modelMenu.innerHTML = `
        <button onclick="openModelModal(); toggleModelMenu()" class="action-item">
            <span>â•</span> <span>${addTexts[currentLang]}</span>
        </button>
        <button onclick="showModelPrintOptions(); toggleModelMenu()" class="action-item">
            <span>ğŸ–¨ï¸</span> <span>${printTexts[currentLang]}</span>
        </button>
    `;
    
    if (modelMenu.classList.contains('active')) {
        modelMenu.classList.remove('active');
        setTimeout(() => modelMenu.style.display = 'none', 200);
    } else {
        modelMenu.style.display = 'flex';
        setTimeout(() => modelMenu.classList.add('active'), 10);
    }
}


// ØªØ­Ù…ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
function loadModelTypesData() {
    const sel = document.getElementById('modelType');
    if (!sel) return;
    
    sel.innerHTML = '';
    modelTypes.forEach((type, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.textContent = type[currentLang] || type.ar;
        sel.appendChild(opt);
    });
}

// Ø¥Ø¯Ø§Ø±Ø© Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
function manageModelTypes() {
    const modal = document.getElementById('modelTypesModal');
    modal.style.display = 'flex';
    updateModalUITexts('modelTypesModal');
    renderModelTypesList();
}

function renderModelTypesList() {
    const list = document.getElementById('modelTypesList');
    list.innerHTML = '';
    
    modelTypes.forEach((type, index) => {
        const li = document.createElement('li');
        li.className = 'config-item';
        li.innerHTML = `
            <div style="display:flex; flex-direction:column;">
                <span style="font-weight:bold;">${type[currentLang] || type.ar}</span>
                <span style="font-size:0.75rem; color:#888;">${type.ar} | ${type.en} | ${type.tr}</span>
            </div>
            <span class="del-btn-small" onclick="deleteModelType(${index})">ğŸ—‘ï¸</span>
        `;
        list.appendChild(li);
    });
}

function addModelType() {
    const ar = document.getElementById('modelTypeAr').value.trim();
    const en = document.getElementById('modelTypeEn').value.trim();
    const tr = document.getElementById('modelTypeTr').value.trim();

    if (!ar || !en || !tr) {
        alert(currentLang === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„ØºØ§Øª Ø§Ù„Ø«Ù„Ø§Ø«' : 'Please fill all 3 languages');
        return;
    }

    const newType = { ar, en, tr };
    modelTypes.push(newType);
    localStorage.setItem('modelTypesObj', JSON.stringify(modelTypes));

    document.getElementById('modelTypeAr').value = '';
    document.getElementById('modelTypeEn').value = '';
    document.getElementById('modelTypeTr').value = '';
    
    renderModelTypesList();
    loadModelTypesData();
}

function deleteModelType(index) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) return;
    
    modelTypes.splice(index, 1);
    localStorage.setItem('modelTypesObj', JSON.stringify(modelTypes));
    renderModelTypesList();
    loadModelTypesData();
}

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
function addDimensionRow() {
    const container = document.getElementById('dimensionsContainer');
    const newRow = document.createElement('div');
    newRow.className = 'dimension-row';
    newRow.style.cssText = 'display:flex; align-items:center; gap:5px; margin-bottom:10px; background:var(--bg-color); padding:10px; border-radius:8px;';
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØµÙˆØµ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const lengthPlaceholder = currentLang === 'ar' ? 'Ø§Ù„Ø·ÙˆÙ„' : (currentLang === 'en' ? 'Length' : 'Uzunluk');
    const widthPlaceholder = currentLang === 'ar' ? 'Ø§Ù„Ø¹Ø±Ø¶' : (currentLang === 'en' ? 'Width' : 'GeniÅŸlik');
    const heightPlaceholder = currentLang === 'ar' ? 'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹' : (currentLang === 'en' ? 'Height' : 'YÃ¼kseklik');
    
    newRow.innerHTML = `
        <input type="number" class="input-field dimension-input dimension-length" style="flex:1; margin:0;" step="0.01" 
               data-ph-ar="Ø§Ù„Ø·ÙˆÙ„" data-ph-en="Length" data-ph-tr="Uzunluk" placeholder="${lengthPlaceholder}">
        <span>Ã—</span>
        <input type="number" class="input-field dimension-input dimension-width" style="flex:1; margin:0;" step="0.01" 
               data-ph-ar="Ø§Ù„Ø¹Ø±Ø¶" data-ph-en="Width" data-ph-tr="GeniÅŸlik" placeholder="${widthPlaceholder}">
        <span>Ã—</span>
        <input type="number" class="input-field dimension-input dimension-height" style="flex:1; margin:0;" step="0.01" 
               data-ph-ar="Ø§Ù„Ø§Ø±ØªÙØ§Ø¹" data-ph-en="Height" data-ph-tr="YÃ¼kseklik" placeholder="${heightPlaceholder}">
        <button type="button" onclick="removeDimensionRow(this)" class="del-btn-small" style="background:#ef4444; color:white; border:none; padding:5px; border-radius:4px;">ğŸ—‘ï¸</button>
    `;
    container.appendChild(newRow);
}

function removeDimensionRow(btn) {
    btn.parentElement.remove();
}

// Ø¥Ø¯Ø§Ø±Ø© Ø­Ù‚ÙˆÙ„ CBM
function addCBMRow() {
    const container = document.getElementById('cbmContainer');
    const newRow = document.createElement('div');
    newRow.className = 'cbm-row';
    newRow.style.cssText = 'display:flex; align-items:center; gap:5px; margin-bottom:10px; background:rgba(13, 124, 102, 0.05); padding:10px; border-radius:8px; border:1px solid var(--primary-color);';
    newRow.innerHTML = `
        <input type="number" placeholder="Ø§Ù„Ø·ÙˆÙ„" class="input-field cbm-input" style="flex:1; margin:0;" step="0.01" oninput="calculateCBM()">
        <span>Ã—</span>
        <input type="number" placeholder="Ø§Ù„Ø¹Ø±Ø¶" class="input-field cbm-input" style="flex:1; margin:0;" step="0.01" oninput="calculateCBM()">
        <span>Ã—</span>
        <input type="number" placeholder="Ø§Ù„Ø§Ø±ØªÙØ§Ø¹" class="input-field cbm-input" style="flex:1; margin:0;" step="0.01" oninput="calculateCBM()">
        <button type="button" onclick="removeCBMRow(this)" class="del-btn-small" style="background:#ef4444; color:white; border:none; padding:5px; border-radius:4px;">ğŸ—‘ï¸</button>
    `;
    container.appendChild(newRow);
}

function removeCBMRow(btn) {
    btn.parentElement.remove();
    calculateCBM();
}

// Ø­Ø³Ø§Ø¨ CBM
function calculateCBM() {
    const cbmInputs = document.querySelectorAll('.cbm-row');
    let totalCBM = 0;
    
    cbmInputs.forEach(row => {
        const inputs = row.querySelectorAll('.cbm-input');
        const length = parseFloat(inputs[0].value) || 0;
        const width = parseFloat(inputs[1].value) || 0;
        const height = parseFloat(inputs[2].value) || 0;
        
        if (length > 0 && width > 0 && height > 0) {
            totalCBM += (length * width * height) / 1000000;
        }
    });
    
    document.getElementById('totalCBM').textContent = totalCBM.toFixed(4);
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
function handleModelImageUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Ø¶ØºØ· Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù€ 40KB
                const maxWidth = 600;
                const scaleSize = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scaleSize;
                
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                let quality = 0.6;
                let dataUrl = canvas.toDataURL('image/jpeg', quality);
                
                // Ø¶ØºØ· ØªØ¯Ø±ÙŠØ¬ÙŠ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù€ 40KB
                while(dataUrl.length > 40000 && quality > 0.1) {
                    quality -= 0.1;
                    dataUrl = canvas.toDataURL('image/jpeg', quality);
                }
                
                document.getElementById('modelPreview').src = dataUrl;
                document.getElementById('modelPreview').style.display = 'block';
                document.getElementById('modelUploadPlaceholder').style.display = 'none';
            }
        }
        reader.readAsDataURL(file);
    }
}


// ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ÙˆØ§Ù„Ù€ CBM
function updateDimensionPlaceholders() {
    // ØªØ­Ø¯ÙŠØ« Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
    document.querySelectorAll('.dimension-length').forEach(input => {
        const placeholder = input.getAttribute(`data-ph-${currentLang}`);
        if (placeholder) input.placeholder = placeholder;
    });
    
    document.querySelectorAll('.dimension-width').forEach(input => {
        const placeholder = input.getAttribute(`data-ph-${currentLang}`);
        if (placeholder) input.placeholder = placeholder;
    });
    
    document.querySelectorAll('.dimension-height').forEach(input => {
        const placeholder = input.getAttribute(`data-ph-${currentLang}`);
        if (placeholder) input.placeholder = placeholder;
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ù‚ÙˆÙ„ CBM
    document.querySelectorAll('.cbm-length').forEach(input => {
        const placeholder = input.getAttribute(`data-ph-${currentLang}`);
        if (placeholder) input.placeholder = placeholder;
    });
    
    document.querySelectorAll('.cbm-width').forEach(input => {
        const placeholder = input.getAttribute(`data-ph-${currentLang}`);
        if (placeholder) input.placeholder = placeholder;
    });
    
    document.querySelectorAll('.cbm-height').forEach(input => {
        const placeholder = input.getAttribute(`data-ph-${currentLang}`);
        if (placeholder) input.placeholder = placeholder;
    });
}



// Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯
function openMaterialSelector() {
    const modal = document.getElementById('materialSelectorModal');
    modal.style.display = 'flex';
    updateModalUITexts('materialSelectorModal');
    loadMaterialsInSelector();
}

function closeMaterialSelector() {
    document.getElementById('materialSelectorModal').style.display = 'none';
}

function loadMaterialsInSelector() {
    const container = document.getElementById('materialSelectorList');
    container.innerHTML = '';
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ
    const grouped = {};
    allMaterials.forEach(m => {
        let catName = 'ØºÙŠØ± Ù…ØµÙ†Ù';
        if (m.category && typeof m.category === 'object') {
            catName = m.category[currentLang] || m.category.ar;
        } else {
            catName = m.category;
        }
        
        if (!grouped[catName]) grouped[catName] = [];
        grouped[catName].push(m);
    });

    for (const [cat, items] of Object.entries(grouped)) {
        // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØµÙ†ÙŠÙ
        const header = document.createElement('div');
        header.className = 'category-header';
        header.innerHTML = `<span>${cat}</span> <span style="font-size:0.8rem; opacity:0.7;">${items.length}</span>`;
        container.appendChild(header);

        // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯
        items.forEach(m => {
            const isSelected = selectedModelMaterials.some(sm => sm.id === m.id);
            
            let dName = m.name;
            if (typeof m.name === 'object') dName = m.name[currentLang] || m.name.ar;
            
            let dUnit = m.unit;
            if (typeof m.unit === 'object') dUnit = m.unit[currentLang] || m.unit.ar;

            const sPrice = (m.price * currencyConfig.rate).toFixed(2);

            const item = document.createElement('div');
            item.className = `material-selector-item ${isSelected ? 'selected' : ''}`;
            item.onclick = () => toggleMaterialSelection(m, item);
            item.innerHTML = `
                <img src="${m.image || 'https://via.placeholder.com/40?text=Img'}" style="width:40px; height:40px; object-fit:cover; border-radius:6px;">
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:0.9rem;">${dName}</div>
                    <div style="font-size:0.75rem; color:var(--text-secondary);">${dUnit}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:bold; color:var(--primary-color);">${m.price} <small>${currencyConfig.primary}</small></div>
                    <div style="font-size:0.7rem; color:#888;">${sPrice} <small>${currencyConfig.secondary}</small></div>
                </div>
            `;
            container.appendChild(item);
        });
    }
}

function toggleMaterialSelection(material, element) {
    const existingIndex = selectedModelMaterials.findIndex(sm => sm.id === material.id);
    
    if (existingIndex > -1) {
        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
        selectedModelMaterials.splice(existingIndex, 1);
        element.classList.remove('selected');
    } else {
        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªØ­Ø¯ÙŠØ¯
        selectedModelMaterials.push({
            ...material,
            quantity: 1,
            totalCost: material.price
        });
        element.classList.add('selected');
    }
    
    updateSelectedMaterialsDisplay();
}

function updateSelectedMaterialsDisplay() {
    const container = document.getElementById('selectedMaterialsList');
    container.innerHTML = '';
    
    selectedModelMaterials.forEach((material, index) => {
        let dName = material.name;
        if (typeof material.name === 'object') dName = material.name[currentLang] || material.name.ar;
        
        let dUnit = material.unit;
        if (typeof material.unit === 'object') dUnit = material.unit[currentLang] || material.unit.ar;

        const item = document.createElement('div');
        item.className = 'selected-material-item';
        item.innerHTML = `
            <img src="${material.image || 'https://via.placeholder.com/40?text=Img'}" alt="Material">
            <div class="selected-material-info">
                <div style="font-weight:bold; font-size:0.9rem;">${dName}</div>
                <div style="font-size:0.75rem; color:var(--text-secondary);">${dUnit} - ${material.price} ${currencyConfig.primary}</div>
            </div>
            <div class="selected-material-controls">
                <input type="number" class="quantity-input" value="${material.quantity}" min="0.01" step="0.01" 
                       onchange="updateMaterialQuantity(${index}, this.value)">
                <span style="font-size:0.8rem; color:var(--primary-color); font-weight:bold; margin-left:5px;">
                    ${material.totalCost.toFixed(2)} ${currencyConfig.primary}
                </span>
                <button onclick="removeMaterialFromSelection(${index})" style="background:#ef4444; color:white; border:none; padding:2px 6px; border-radius:4px; margin-left:5px;">âœ•</button>
            </div>
        `;
        container.appendChild(item);
    });
    
    calculateModelTotalCost();
}

function updateMaterialQuantity(index, quantity) {
    const qty = parseFloat(quantity) || 0;
    selectedModelMaterials[index].quantity = qty;
    selectedModelMaterials[index].totalCost = selectedModelMaterials[index].price * qty;
    updateSelectedMaterialsDisplay();
}

function removeMaterialFromSelection(index) {
    selectedModelMaterials.splice(index, 1);
    updateSelectedMaterialsDisplay();
    loadMaterialsInSelector(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
}

function filterMaterialsInSelector() {
    const query = document.getElementById('materialSelectorSearch').value.toLowerCase();
    const items = document.querySelectorAll('.material-selector-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(query) ? 'flex' : 'none';
    });
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
function calculateModelTotalCost() {
    const laborCost = parseFloat(document.getElementById('modelLaborCost').value) || 0;
    const otherCosts = parseFloat(document.getElementById('modelOtherCosts').value) || 0;
    
    // Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯
    const materialsCost = selectedModelMaterials.reduce((sum, material) => {
        return sum + material.totalCost;
    }, 0);
    
    const totalCostPrimary = materialsCost + laborCost + otherCosts;
    const totalCostSecondary = totalCostPrimary * currencyConfig.rate;
    
    document.getElementById('modelTotalCostPrimary').textContent = totalCostPrimary.toFixed(2);
    document.getElementById('modelTotalCostSecondary').textContent = totalCostSecondary.toFixed(2);
    document.getElementById('modelCostCurrPrimary').textContent = currencyConfig.primary;
    document.getElementById('modelCostCurrSecondary').textContent = currencyConfig.secondary;
}

// ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„
function openModelModal(id = null) {
    const modal = document.getElementById('modelModal');
    modal.style.display = 'flex';
    
    updateModalUITexts('modelModal');
    loadModelTypesData();
    
    const titleEl = document.getElementById('modelModalTitle');
    const titleText = id ? 
        (currentLang === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¯ÙŠÙ„' : 'Edit Model') : 
        (currentLang === 'ar' ? 'Ù…ÙˆØ¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯' : 'New Model');
    if (currentLang === 'tr') titleEl.textContent = id ? 'Model DÃ¼zenle' : 'Yeni Model';
    else titleEl.textContent = titleText;

    document.getElementById('modelId').value = id || '';
    selectedModelMaterials = [];

    if (id) {
        // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        loadModelForEdit(id);
        document.getElementById('btnDeleteModel').style.display = 'block';
    } else {
        // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        clearModelForm();
        document.getElementById('btnDeleteModel').style.display = 'none';
    }
    
    calculateModelTotalCost();
}

function loadModelForEdit(id) {
    const transaction = db.transaction(['models'], 'readonly');
    const store = transaction.objectStore('models');
    const request = store.get(Number(id));
    
    request.onsuccess = (e) => {
        const model = e.target.result;
        
        // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        document.getElementById('modelNameAr').value = model.name.ar || '';
        document.getElementById('modelNameEn').value = model.name.en || '';
        document.getElementById('modelNameTr').value = model.name.tr || '';
        
        // Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„
        const typeIdx = modelTypes.findIndex(t => t.ar === (model.type.ar || model.type));
        if (typeIdx > -1) document.getElementById('modelType').value = typeIdx;
        
        // Ø§Ù„ÙˆØµÙ
        if (model.description) {
            document.getElementById('modelDescAr').value = model.description.ar || '';
            document.getElementById('modelDescEn').value = model.description.en || '';
            document.getElementById('modelDescTr').value = model.description.tr || '';
        }
        
        // Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
        if (model.dimensions && model.dimensions.length > 0) {
            const container = document.getElementById('dimensionsContainer');
            container.innerHTML = '';
            model.dimensions.forEach(dim => {
                addDimensionRow();
                const lastRow = container.lastElementChild;
                const inputs = lastRow.querySelectorAll('.dimension-input');
                inputs[0].value = dim.length || '';
                inputs[1].value = dim.width || '';
                inputs[2].value = dim.height || '';
            });
        }
        
        // CBM
        if (model.cbmCalculations && model.cbmCalculations.length > 0) {
            const container = document.getElementById('cbmContainer');
            container.innerHTML = '';
            model.cbmCalculations.forEach(cbm => {
                addCBMRow();
                const lastRow = container.lastElementChild;
                const inputs = lastRow.querySelectorAll('.cbm-input');
                inputs[0].value = cbm.length || '';
                inputs[1].value = cbm.width || '';
                inputs[2].value = cbm.height || '';
            });
            calculateCBM();
        }
        
        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        document.getElementById('modelColor').value = model.color || '';
        document.getElementById('modelWeight').value = model.weight || '';
        document.getElementById('modelPackets').value = model.packets || 1;
        document.getElementById('modelLaborCost').value = model.laborCost || '';
        document.getElementById('modelOtherCosts').value = model.otherCosts || '';
        document.getElementById('modelSellingPrice').value = model.sellingPrice || '';
        document.getElementById('modelNotes').value = model.notes || '';
        
        // Ø§Ù„ØµÙˆØ±Ø©
        if (model.image) {
            document.getElementById('modelPreview').src = model.image;
            document.getElementById('modelPreview').style.display = 'block';
            document.getElementById('modelUploadPlaceholder').style.display = 'none';
        }
        
        // Ø§Ù„Ù…ÙˆØ§Ø¯
        selectedModelMaterials = model.materials || [];
        updateSelectedMaterialsDisplay();
    };
}

function clearModelForm() {
    // ØªÙØ±ÙŠØº Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById('modelNameAr').value = '';
    document.getElementById('modelNameEn').value = '';
    document.getElementById('modelNameTr').value = '';
    document.getElementById('modelDescAr').value = '';
    document.getElementById('modelDescEn').value = '';
    document.getElementById('modelDescTr').value = '';
    document.getElementById('modelColor').value = '';
    document.getElementById('modelWeight').value = '';
    document.getElementById('modelPackets').value = '1';
    document.getElementById('modelLaborCost').value = '';
    document.getElementById('modelOtherCosts').value = '';
    document.getElementById('modelSellingPrice').value = '';
    document.getElementById('modelNotes').value = '';
    
    // ØªÙØ±ÙŠØº Ø§Ù„ØµÙˆØ±Ø©
    document.getElementById('modelPreview').src = '';
    document.getElementById('modelPreview').style.display = 'none';
    document.getElementById('modelUploadPlaceholder').style.display = 'block';
    
 // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ÙˆØ§Ù„Ù€ CBM
const lengthPlaceholder = currentLang === 'ar' ? 'Ø§Ù„Ø·ÙˆÙ„' : (currentLang === 'en' ? 'Length' : 'Uzunluk');
const widthPlaceholder = currentLang === 'ar' ? 'Ø§Ù„Ø¹Ø±Ø¶' : (currentLang === 'en' ? 'Width' : 'GeniÅŸlik');
const heightPlaceholder = currentLang === 'ar' ? 'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹' : (currentLang === 'en' ? 'Height' : 'YÃ¼kseklik');

document.getElementById('dimensionsContainer').innerHTML = `
    <div class="dimension-row" style="display:flex; align-items:center; gap:5px; margin-bottom:10px; background:var(--bg-color); padding:10px; border-radius:8px;">
        <input type="number" class="input-field dimension-input dimension-length" style="flex:1; margin:0;" step="0.01" 
               data-ph-ar="Ø§Ù„Ø·ÙˆÙ„" data-ph-en="Length" data-ph-tr="Uzunluk" placeholder="${lengthPlaceholder}">
        <span>Ã—</span>
        <input type="number" class="input-field dimension-input dimension-width" style="flex:1; margin:0;" step="0.01" 
               data-ph-ar="Ø§Ù„Ø¹Ø±Ø¶" data-ph-en="Width" data-ph-tr="GeniÅŸlik" placeholder="${widthPlaceholder}">
        <span>Ã—</span>
        <input type="number" class="input-field dimension-input dimension-height" style="flex:1; margin:0;" step="0.01" 
               data-ph-ar="Ø§Ù„Ø§Ø±ØªÙØ§Ø¹" data-ph-en="Height" data-ph-tr="YÃ¼kseklik" placeholder="${heightPlaceholder}">
        <button type="button" onclick="removeDimensionRow(this)" class="del-btn-small" style="background:#ef4444; color:white; border:none; padding:5px; border-radius:4px;">ğŸ—‘ï¸</button>
    </div>
`;

document.getElementById('cbmContainer').innerHTML = `
    <div class="cbm-row" style="display:flex; align-items:center; gap:5px; margin-bottom:10px; background:rgba(13, 124, 102, 0.05); padding:10px; border-radius:8px; border:1px solid var(--primary-color);">
        <input type="number" class="input-field cbm-input cbm-length" style="flex:1; margin:0;" step="0.01" oninput="calculateCBM()" 
               data-ph-ar="Ø§Ù„Ø·ÙˆÙ„" data-ph-en="Length" data-ph-tr="Uzunluk" placeholder="${lengthPlaceholder}">
        <span>Ã—</span>
        <input type="number" class="input-field cbm-input cbm-width" style="flex:1; margin:0;" step="0.01" oninput="calculateCBM()" 
               data-ph-ar="Ø§Ù„Ø¹Ø±Ø¶" data-ph-en="Width" data-ph-tr="GeniÅŸlik" placeholder="${widthPlaceholder}">
        <span>Ã—</span>
        <input type="number" class="input-field cbm-input cbm-height" style="flex:1; margin:0;" step="0.01" oninput="calculateCBM()" 
               data-ph-ar="Ø§Ù„Ø§Ø±ØªÙØ§Ø¹" data-ph-en="Height" data-ph-tr="YÃ¼kseklik" placeholder="${heightPlaceholder}">
        <button type="button" onclick="removeCBMRow(this)" class="del-btn-small" style="background:#ef4444; color:white; border:none; padding:5px; border-radius:4px;">ğŸ—‘ï¸</button>
    </div>
`;


calculateCBM();
updateSelectedMaterialsDisplay();
}

function closeModelModal() {
    document.getElementById('modelModal').style.display = 'none';
}

// Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„
function saveModel() {
    // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    const nameAr = sanitizeText(document.getElementById('modelNameAr').value);
    const nameEn = sanitizeText(document.getElementById('modelNameEn').value);
    const nameTr = sanitizeText(document.getElementById('modelNameTr').value);
    
    const descAr = sanitizeText(document.getElementById('modelDescAr').value);
    const descEn = sanitizeText(document.getElementById('modelDescEn').value);
    const descTr = sanitizeText(document.getElementById('modelDescTr').value);
    
    const typeIndex = document.getElementById('modelType').value;
    const typeObj = modelTypes[typeIndex];
    
    const color = sanitizeText(document.getElementById('modelColor').value);
    const weight = parseFloat(document.getElementById('modelWeight').value) || 0;
    const packets = parseInt(document.getElementById('modelPackets').value) || 1;
    const laborCost = parseFloat(document.getElementById('modelLaborCost').value) || 0;
    const otherCosts = parseFloat(document.getElementById('modelOtherCosts').value) || 0;
    const sellingPrice = parseFloat(document.getElementById('modelSellingPrice').value) || 0;
    const notes = sanitizeText(document.getElementById('modelNotes').value);
    const image = document.getElementById('modelPreview').src;
    const id = document.getElementById('modelId').value;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!nameAr || !nameEn || !nameTr) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„ØºØ§Øª');
        return;
    }

    // Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
    const dimensions = [];
    document.querySelectorAll('.dimension-row').forEach(row => {
        const inputs = row.querySelectorAll('.dimension-input');
        const length = parseFloat(inputs[0].value) || 0;
        const width = parseFloat(inputs[1].value) || 0;
        const height = parseFloat(inputs[2].value) || 0;
        
        if (length > 0 || width > 0 || height > 0) {
            dimensions.push({ length, width, height });
        }
    });

    // Ø¬Ù…Ø¹ Ø­Ø³Ø§Ø¨Ø§Øª CBM
    const cbmCalculations = [];
    document.querySelectorAll('.cbm-row').forEach(row => {
        const inputs = row.querySelectorAll('.cbm-input');
        const length = parseFloat(inputs[0].value) || 0;
        const width = parseFloat(inputs[1].value) || 0;
        const height = parseFloat(inputs[2].value) || 0;
        
        if (length > 0 && width > 0 && height > 0) {
            const cbm = (length * width * height) / 1000000;
            cbmCalculations.push({ length, width, height, cbm });
        }
    });

    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ CBM
    const totalCBM = cbmCalculations.reduce((sum, calc) => sum + calc.cbm, 0);

    // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
    const materialsCost = selectedModelMaterials.reduce((sum, material) => sum + material.totalCost, 0);
    const totalCost = materialsCost + laborCost + otherCosts;

    // ØªÙƒÙˆÙŠÙ† ÙƒØ§Ø¦Ù† Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„
    const modelData = {
        name: { ar: nameAr, en: nameEn, tr: nameTr },
        type: typeObj,
        description: { ar: descAr, en: descEn, tr: descTr },
        dimensions,
        cbmCalculations,
        totalCBM,
        color,
        weight,
        packets,
        laborCost,
        otherCosts,
        sellingPrice,
        notes,
        materials: selectedModelMaterials,
        materialsCost,
        totalCost,
        image: image.includes('data:image') ? image : '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };

    // Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const transaction = db.transaction(['models'], 'readwrite');
    const store = transaction.objectStore('models');

    if (id) {
        // ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¯ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯
        modelData.id = Number(id);
        modelData.createdAt = undefined; // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠ
        store.put(modelData);
    } else {
        // Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
        store.add(modelData);
    }

    transaction.oncomplete = () => {
        closeModelModal();
        loadModels();
        selectedModelMaterials = []; // ØªÙØ±ÙŠØº Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    };

    transaction.onerror = (e) => {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„:', e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„');
    };
}

// Ø­Ø°Ù Ù…ÙˆØ¯ÙŠÙ„
function deleteModel() {
    const id = Number(document.getElementById('modelId').value);
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ØŸ')) {
        const transaction = db.transaction(['models'], 'readwrite');
        transaction.objectStore('models').delete(id);
        transaction.oncomplete = () => {
            closeModelModal();
            loadModels();
        };
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
function loadModels() {
    if (!db) {
        setTimeout(loadModels, 500); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ù†ØµÙ Ø«Ø§Ù†ÙŠØ©
        return;
    }

    const transaction = db.transaction(['models'], 'readonly');
    const store = transaction.objectStore('models');
    const request = store.getAll();

    request.onsuccess = (e) => {
        allModels = e.target.result || [];
        renderModels(allModels);
    };

    request.onerror = (e) => {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª:', e);
        allModels = [];
        renderModels([]);
    };
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª - Ù…Ø­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØµØ­ÙŠØ­Ø©
function renderModels(modelsList) {
    const container = document.getElementById('modelsList');
    if (!container) return;
    
    container.innerHTML = '';

    if (modelsList.length === 0) {
        const emptyTexts = {
            ar: { title: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¯ÙŠÙ„Ø§Øª', desc: 'Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯' },
            en: { title: 'No Models', desc: 'Start by adding a new model' },
            tr: { title: 'Model Yok', desc: 'Yeni bir model ekleyerek baÅŸlayÄ±n' }
        };
        
        const texts = emptyTexts[currentLang];
        
        container.innerHTML = `
            <div class="empty-content">
                <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ—ï¸</div>
                <h3>${texts.title}</h3>
                <p>${texts.desc}</p>
            </div>
        `;
        return;
    }

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    const grouped = {};
    modelsList.forEach(model => {
        let typeName = 'ØºÙŠØ± Ù…ØµÙ†Ù';
        if (model.type && typeof model.type === 'object') {
            typeName = model.type[currentLang] || model.type.ar;
        } else {
            typeName = model.type || 'ØºÙŠØ± Ù…ØµÙ†Ù';
        }
        
        if (!grouped[typeName]) grouped[typeName] = [];
        grouped[typeName].push(model);
    });

    // Ø¹Ø±Ø¶ ÙƒÙ„ Ù†ÙˆØ¹ ÙˆÙ…ÙˆØ¯ÙŠÙ„Ø§ØªÙ‡
    for (const [type, models] of Object.entries(grouped)) {
        // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†ÙˆØ¹
        const header = document.createElement('div');
        header.className = 'category-header';
        header.innerHTML = `<span>${type}</span> <span style="font-size:0.8rem; opacity:0.7;">${models.length}</span>`;
        container.appendChild(header);

        // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
        models.forEach(model => {
            const card = createModelCard(model);
            container.appendChild(card);
        });
    }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ù…ÙˆØ¯ÙŠÙ„
function createModelCard(model) {
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØµÙˆØµ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
    let modelName = model.name;
    if (typeof model.name === 'object') {
        modelName = model.name[currentLang] || model.name.ar;
    }

    let typeName = model.type;
    if (typeof model.type === 'object') {
        typeName = model.type[currentLang] || model.type.ar;
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©
    const totalCostSecondary = (model.totalCost * currencyConfig.rate).toFixed(2);
    const sellingPriceSecondary = (model.sellingPrice * currencyConfig.rate).toFixed(2);

    const card = document.createElement('div');
    card.className = 'model-card';
    card.onclick = () => openModelModal(model.id);
    
    card.innerHTML = `
        <div class="model-card-header">
            <img src="${model.image || 'https://via.placeholder.com/80?text=Model'}" class="model-card-image" alt="Model Image">
            <div class="model-card-info">
                <div class="model-card-title">${modelName}</div>
                <div class="model-card-type">${typeName}</div>
                <div style="font-size:0.8rem; color:var(--text-secondary); margin-top:5px;">
                    ${model.color ? `ğŸ¨ ${model.color}` : ''} 
                    ${model.weight ? `âš–ï¸ ${model.weight}kg` : ''}
                    ${model.packets ? `ğŸ“¦ ${model.packets}` : ''}
                </div>
            </div>
        </div>
        
        <div class="model-card-details">
            <div class="model-detail-item">
                <div class="model-detail-label" data-ar="Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒÙ„ÙŠ" data-en="Total Volume" data-tr="Toplam Hacim">Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒÙ„ÙŠ</div>
                <div class="model-detail-value">${model.totalCBM ? model.totalCBM.toFixed(4) : '0.0000'} CBM</div>
            </div>
            
            <div class="model-detail-item">
                <div class="model-detail-label" data-ar="Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯" data-en="Materials Count" data-tr="Malzeme SayÄ±sÄ±">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</div>
                <div class="model-detail-value">${model.materials ? model.materials.length : 0}</div>
            </div>
            
            <div class="model-detail-item">
                <div class="model-detail-label" data-ar="Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©" data-en="Total Cost" data-tr="Toplam Maliyet">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div>
                <div class="model-detail-value">
                    ${model.totalCost ? model.totalCost.toFixed(2) : '0.00'} ${currencyConfig.primary}
                    <br><small style="opacity:0.7;">${totalCostSecondary} ${currencyConfig.secondary}</small>
                </div>
            </div>
            
            ${model.sellingPrice ? `
            <div class="model-detail-item">
                <div class="model-detail-label" data-ar="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹" data-en="Selling Price" data-tr="SatÄ±ÅŸ FiyatÄ±">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</div>
                <div class="model-detail-value">
                    ${model.sellingPrice.toFixed(2)} ${currencyConfig.primary}
                    <br><small style="opacity:0.7;">${sellingPriceSecondary} ${currencyConfig.secondary}</small>
                </div>
            </div>
            ` : ''}
        </div>
    `;

    return card;
}

// Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
function debouncedModelSearch() {
    clearTimeout(modelSearchTimeout);
    modelSearchTimeout = setTimeout(() => {
        filterModels();
    }, 300);
}

function filterModels() {
    const query = document.getElementById('modelSearch').value.toLowerCase();
    
    const filtered = allModels.filter(model => {
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø§Ø³Ù…
        let nameMatch = false;
        if (typeof model.name === 'object') {
            nameMatch = (model.name.ar && model.name.ar.toLowerCase().includes(query)) || 
                        (model.name.en && model.name.en.toLowerCase().includes(query)) || 
                        (model.name.tr && model.name.tr.toLowerCase().includes(query));
        } else {
            nameMatch = model.name.toLowerCase().includes(query);
        }

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù†ÙˆØ¹
        let typeMatch = false;
        if (typeof model.type === 'object') {
            typeMatch = (model.type.ar && model.type.ar.toLowerCase().includes(query)) ||
                        (model.type.en && model.type.en.toLowerCase().includes(query)) ||
                        (model.type.tr && model.type.tr.toLowerCase().includes(query));
        } else {
            typeMatch = model.type && model.type.toLowerCase().includes(query);
        }

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØµÙ
        let descMatch = false;
        if (model.description && typeof model.description === 'object') {
            descMatch = (model.description.ar && model.description.ar.toLowerCase().includes(query)) ||
                        (model.description.en && model.description.en.toLowerCase().includes(query)) ||
                        (model.description.tr && model.description.tr.toLowerCase().includes(query));
        }

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù„ÙˆÙ† ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
        const colorMatch = model.color && model.color.toLowerCase().includes(query);
        const notesMatch = model.notes && model.notes.toLowerCase().includes(query);
        
        return nameMatch || typeMatch || descMatch || colorMatch || notesMatch;
    });
    
    renderModels(filtered);
}

/* ============================================================ */
/* ğŸ–¨ï¸ Ù†Ø¸Ø§Ù… Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª */
/* ============================================================ */

function showModelPrintOptions() {
    const modal = document.getElementById('modelPrintModal');
    const searchVal = document.getElementById('modelSearch').value.trim();
    
    // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø®ÙŠØ§Ø± Ø·Ø¨Ø§Ø¹Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
    const searchBtn = document.getElementById('modelOptSearch');
    if (!searchVal) {
        searchBtn.classList.add('disabled');
        if (selectedModelPrintType === 'search') {
            selectModelPrintType(document.querySelector('.print-card'), 'all');
        }
    } else {
        searchBtn.classList.remove('disabled');
    }

    // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
    const typeSel = document.getElementById('modelPrintTypeSelect');
    typeSel.innerHTML = `<option value="all_types">${currentLang === 'ar' ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹' : 'All Types'}</option>`;
    modelTypes.forEach((type, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = type[currentLang] || type.ar;
        typeSel.appendChild(opt);
    });

    // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„Ù†Ø§ÙØ°Ø©
    modal.querySelectorAll('[data-ar]').forEach(el => {
        el.textContent = el.getAttribute(`data-${currentLang}`) || el.getAttribute('data-ar');
    });

    modal.style.display = 'flex';
}

function selectModelPrintType(el, type) {
    document.querySelectorAll('#modelPrintModal .print-card').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    selectedModelPrintType = type;

    // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
    document.getElementById('modelPrintTypeSelectWrapper').style.display = (type === 'type') ? 'block' : 'none';
}

function executeModelPrint() {
    document.getElementById('modelPrintModal').style.display = 'none';

    // Ø¬Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    const printLang = document.getElementById('modelPrintLangSelect').value;
    const includeImages = document.getElementById('printModelImages').checked;
    const includeMaterials = document.getElementById('printModelMaterials').checked;
    const includePrices = document.getElementById('printModelPrices').checked;
    const includeDimensions = document.getElementById('printModelDimensions').checked;
    const typeFilterVal = document.getElementById('modelPrintTypeSelect').value;

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§
    let modelsToPrint = allModels;

    if (selectedModelPrintType === 'search') {
        // Ø·Ø¨Ø§Ø¹Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
        const query = document.getElementById('modelSearch').value.toLowerCase();
        modelsToPrint = allModels.filter(model => {
            const searchText = JSON.stringify(model).toLowerCase();
            return searchText.includes(query);
        });
    } 
    else if (selectedModelPrintType === 'type') {
        // Ø·Ø¨Ø§Ø¹Ø© Ù†ÙˆØ¹ Ù…Ø­Ø¯Ø¯
        if (typeFilterVal !== 'all_types') {
            const selectedTypeObj = modelTypes[typeFilterVal];
            modelsToPrint = allModels.filter(model => {
                const modelTypeAr = model.type.ar || model.type;
                return modelTypeAr === selectedTypeObj.ar;
            });
        }
    }

    // ØªØ­Ø¯ÙŠØ¯ Ù„ØºØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    const targetLang = (printLang === 'current') ? currentLang : printLang;

    generateModelPrintHTML(modelsToPrint, targetLang, {
        includeImages,
        includeMaterials,
        includePrices,
        includeDimensions
    });
}

function generateModelPrintHTML(data, langMode, options) {
    // Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
    const getText = (obj) => {
        if (typeof obj !== 'object') return obj;
        
        if (langMode === 'all') {
            return `
                <div class="txt-ar">${obj.ar}</div>
                <div class="txt-en">${obj.en}</div>
                <div class="txt-tr">${obj.tr}</div>
            `;
        } else {
            return obj[langMode] || obj.ar;
        }
    };

    // Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
    const headers = {
        ar: { 
            title: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª', 
            name: 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„', 
            type: 'Ø§Ù„Ù†ÙˆØ¹', 
            dimensions: 'Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯',
            cbm: 'Ø§Ù„Ø­Ø¬Ù… (CBM)',
            materials: 'Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©',
            cost: 'Ø§Ù„ØªÙƒÙ„ÙØ©',
            selling: 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹',
            details: 'Ø§Ù„ØªÙØ§ØµÙŠÙ„'
        },
        en: { 
            title: 'Models Report', 
            name: 'Model Name', 
            type: 'Type', 
            dimensions: 'Dimensions',
            cbm: 'Volume (CBM)',
            materials: 'Used Materials',
            cost: 'Cost',
            selling: 'Selling Price',
            details: 'Details'
        },
        tr: { 
            title: 'Modeller Raporu', 
            name: 'Model AdÄ±', 
            type: 'TÃ¼r', 
            dimensions: 'Boyutlar',
            cbm: 'Hacim (CBM)',
            materials: 'KullanÄ±lan Malzemeler',
            cost: 'Maliyet',
            selling: 'SatÄ±ÅŸ FiyatÄ±',
            details: 'Detaylar'
        },
        all: { 
            title: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª / Models Report', 
            name: '<span class="th-ar">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</span><br><span class="th-en">Model Name</span>',
            type: '<span class="th-ar">Ø§Ù„Ù†ÙˆØ¹</span><br><span class="th-en">Type</span>',
            dimensions: '<span class="th-ar">Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</span><br><span class="th-en">Dimensions</span>',
            cbm: '<span class="th-ar">Ø§Ù„Ø­Ø¬Ù…</span><br><span class="th-en">Volume</span>',
            materials: '<span class="th-ar">Ø§Ù„Ù…ÙˆØ§Ø¯</span><br><span class="th-en">Materials</span>',
            cost: '<span class="th-ar">Ø§Ù„ØªÙƒÙ„ÙØ©</span><br><span class="th-en">Cost</span>',
            selling: '<span class="th-ar">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</span><br><span class="th-en">Selling Price</span>',
            details: '<span class="th-ar">Ø§Ù„ØªÙØ§ØµÙŠÙ„</span><br><span class="th-en">Details</span>'
        }
    };
    
    const H = headers[langMode] || headers.ar;
    const isMulti = langMode === 'all';

    // Ø¨Ù†Ø§Ø¡ HTML Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    let html = `
    <html>
    <head>
        <title>Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª</title>
        <style>
            body { 
                font-family: 'Segoe UI', Tahoma, sans-serif; 
                padding: 20px; 
                direction: ${langMode === 'ar' ? 'rtl' : 'ltr'}; 
                color: #333;
                line-height: 1.6;
            }
            .header { 
                text-align: center; 
                margin-bottom: 30px; 
                border-bottom: 3px solid #0d7c66; 
                padding-bottom: 15px; 
            }
            .header h1 {
                color: #0d7c66;
                margin: 0 0 10px 0;
            }
            .model-card {
                background: #f8f9fa;
                border: 2px solid #dee2e6;
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 30px;
                page-break-inside: avoid;
            }
            .model-header {
                display: flex;
                align-items: center;
                gap: 20px;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #0d7c66;
            }
            .model-image {
                width: 120px;
                height: 120px;
                object-fit: cover;
                border-radius: 8px;
                border: 2px solid #dee2e6;
            }
            .model-info h2 {
                color: #0d7c66;
                margin: 0 0 10px 0;
                font-size: 1.5rem;
            }
            .model-type {
                background: #0d7c66;
                color: white;
                padding: 5px 15px;
                border-radius: 20px;
                display: inline-block;
                font-size: 0.9rem;
            }
            .details-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin: 20px 0;
            }
            .detail-item {
                background: white;
                padding: 15px;
                border-radius: 8px;
                border: 1px solid #dee2e6;
            }
            .detail-label {
                font-weight: bold;
                color: #0d7c66;
                margin-bottom: 5px;
            }
            .materials-section {
                background: #e8f5e8;
                padding: 15px;
                border-radius: 8px;
                margin: 15px 0;
            }
            .materials-list {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 10px;
                margin-top: 10px;
            }
            .material-item {
                background: white;
                padding: 10px;
                border-radius: 6px;
                border: 1px solid #ccc;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .material-image {
                width: 40px;
                height: 40px;
                object-fit: cover;
                border-radius: 4px;
            }
            .cost-summary {
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 20px;
                border-radius: 12px;
                text-align: center;
                margin-top: 20px;
            }
            .txt-ar { 
                font-weight: bold; 
                font-size: 1.1em; 
                color: #000; 
            }
            .txt-en { 
                font-size: 0.9em; 
                color: #555; 
            }
            .txt-tr { 
                font-size: 0.85em; 
                color: #777; 
                font-style: italic; 
            }
            @media print {
                body { margin: 0; }
                .model-card { page-break-inside: avoid; }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>${H.title}</h1>
            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª: ${data.length} | Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p>
        </div>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
    data.forEach((model, index) => {
        const modelName = getText(model.name);
        const modelType = getText(model.type);
        const modelDesc = model.description ? getText(model.description) : '';
        
        const totalCostSecondary = (model.totalCost * currencyConfig.rate).toFixed(2);
        const sellingPriceSecondary = model.sellingPrice ? (model.sellingPrice * currencyConfig.rate).toFixed(2) : null;

        html += `
        <div class="model-card">
            <div class="model-header">
                ${options.includeImages ? `<img src="${model.image || 'https://via.placeholder.com/120?text=Model'}" class="model-image" alt="Model Image">` : ''}
                <div class="model-info">
                    <h2>${modelName}</h2>
                    <div class="model-type">${modelType}</div>
                    ${modelDesc ? `<p style="margin-top:10px; font-style:italic;">${modelDesc}</p>` : ''}
                </div>
            </div>

            <div class="details-grid">
                ${options.includeDimensions && model.totalCBM ? `
                <div class="detail-item">
                    <div class="detail-label">${H.cbm}</div>
                    <div>${model.totalCBM.toFixed(4)} CBM</div>
                </div>
                ` : ''}
                
                ${model.color ? `
                <div class="detail-item">
                    <div class="detail-label">Ø§Ù„Ù„ÙˆÙ† / Color</div>
                    <div>${model.color}</div>
                </div>
                ` : ''}
                
                ${model.weight ? `
                <div class="detail-item">
                    <div class="detail-label">Ø§Ù„ÙˆØ²Ù† / Weight</div>
                    <div>${model.weight} kg</div>
                </div>
                ` : ''}
                
                ${model.packets ? `
                <div class="detail-item">
                    <div class="detail-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø§ÙƒÙŠØª / Packets</div>
                    <div>${model.packets}</div>
                </div>
                ` : ''}
            </div>

            ${options.includeDimensions && model.dimensions && model.dimensions.length > 0 ? `
            <div class="detail-item" style="margin:15px 0;">
                <div class="detail-label">${H.dimensions}</div>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:5px;">
                    ${model.dimensions.map(dim => `
                        <span style="background:#f0f0f0; padding:5px 10px; border-radius:15px; font-size:0.9rem;">
                            ${dim.length} Ã— ${dim.width} Ã— ${dim.height}
                        </span>
                    `).join('')}
                </div>
            </div>
            ` : ''}

            ${options.includeMaterials && model.materials && model.materials.length > 0 ? `
            <div class="materials-section">
                <div class="detail-label">${H.materials} (${model.materials.length})</div>
                <div class="materials-list">
                    ${model.materials.map(material => {
                        let matName = material.name;
                        if (typeof material.name === 'object') {
                            matName = getText(material.name);
                        }
                        
                        let matUnit = material.unit;
                        if (typeof material.unit === 'object') {
                            matUnit = getText(material.unit);
                        }

                        return `
                        <div class="material-item">
                            ${options.includeImages ? `<img src="${material.image || 'https://via.placeholder.com/40?text=M'}" class="material-image" alt="Material">` : ''}
                            <div style="flex:1;">
                                <div style="font-weight:bold; font-size:0.9rem;">${matName}</div>
                                <div style="font-size:0.8rem; color:#666;">
                                    ${material.quantity} ${matUnit}
                                    ${options.includePrices ? ` - ${material.totalCost.toFixed(2)} ${currencyConfig.primary}` : ''}
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
            ` : ''}

            ${options.includePrices ? `
            <div class="cost-summary">
                <h3 style="margin:0 0 15px 0;">${H.cost}</h3>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; text-align:center;">
                    ${model.materialsCost ? `
                    <div>
                        <div style="font-size:0.9rem; opacity:0.9;">ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯</div>
                        <div style="font-size:1.1rem; font-weight:bold;">
                            ${model.materialsCost.toFixed(2)} ${currencyConfig.primary}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${model.laborCost ? `
                    <div>
                        <div style="font-size:0.9rem; opacity:0.9;">ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù…Ø§Ù„Ø©</div>
                        <div style="font-size:1.1rem; font-weight:bold;">
                            ${model.laborCost.toFixed(2)} ${currencyConfig.primary}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${model.otherCosts ? `
                    <div>
                        <div style="font-size:0.9rem; opacity:0.9;">ØªÙƒØ§Ù„ÙŠÙ Ø£Ø®Ø±Ù‰</div>
                        <div style="font-size:1.1rem; font-weight:bold;">
                            ${model.otherCosts.toFixed(2)} ${currencyConfig.primary}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="border-left:2px solid rgba(255,255,255,0.3); padding-left:15px;">
                        <div style="font-size:0.9rem; opacity:0.9;">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div>
                        <div style="font-size:1.3rem; font-weight:bold;">
                            ${model.totalCost ? model.totalCost.toFixed(2) : '0.00'} ${currencyConfig.primary}
                        </div>
                        <div style="font-size:0.9rem; opacity:0.8;">
                            ${totalCostSecondary} ${currencyConfig.secondary}
                        </div>
                    </div>
                    
                    ${model.sellingPrice ? `
                    <div style="border-left:2px solid rgba(255,255,255,0.3); padding-left:15px;">
                        <div style="font-size:0.9rem; opacity:0.9;">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</div>
                        <div style="font-size:1.3rem; font-weight:bold;">
                            ${model.sellingPrice.toFixed(2)} ${currencyConfig.primary}
                        </div>
                        <div style="font-size:0.9rem; opacity:0.8;">
                            ${sellingPriceSecondary} ${currencyConfig.secondary}
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : ''}

            ${model.notes ? `
            <div style="margin-top:15px; padding:15px; background:#fff3cd; border-radius:8px; border-left:4px solid #ffc107;">
                <div style="font-weight:bold; color:#856404; margin-bottom:5px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</div>
                <div style="color:#856404;">${model.notes}</div>
            </div>
            ` : ''}
        </div>
        `;
    });

    html += `
        <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #666; border-top:2px solid #dee2e6; padding-top:20px;">
            ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„ - Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
        </div>
    </body>
    </html>`;

    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
    const win = window.open('', '', 'width=1000,height=800');
    win.document.write(html);
    win.document.close();
    
    // Ø·Ø¨Ø§Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    setTimeout(() => {
        win.focus();
        win.print();
    }, 1000);
}

/* ============================================================ */
/* ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
/* ============================================================ */

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© initDB Ù„ØªØ´Ù…Ù„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
const originalInitDB = initDB;
initDB = function() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION + 1);
        
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (!db.objectStoreNames.contains('materials')) {
                const store = db.createObjectStore('materials', { keyPath: 'id', autoIncrement: true });
                store.createIndex('category', 'category', { unique: false });
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (!db.objectStoreNames.contains('models')) {
                const modelStore = db.createObjectStore('models', { keyPath: 'id', autoIncrement: true });
                modelStore.createIndex('type', 'type', { unique: false });
                modelStore.createIndex('name', 'name', { unique: false });
            }
        };
        
        request.onsuccess = (e) => { 
            db = e.target.result; 
            resolve(db); 
            loadMaterials();
            loadModels();
        };
        
        request.onerror = (e) => reject('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    });
};

/* ============================================================ */
/* ğŸ¯ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª */
/* ============================================================ */

// Ø¯Ø§Ù„Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
function getModelsStats() {
    const stats = {
        totalModels: allModels.length,
        typesCount: {},
        averageCost: 0,
        totalValue: 0,
        totalCBM: 0,
        costRange: { min: Infinity, max: -Infinity }
    };
    
    if (allModels.length === 0) return stats;
    
    let totalCost = 0;
    
    allModels.forEach(model => {
        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
        const typeName = model.type.ar || model.type;
        stats.typesCount[typeName] = (stats.typesCount[typeName] || 0) + 1;
        
        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙƒÙ„ÙØ©
        if (model.totalCost) {
            totalCost += model.totalCost;
            stats.totalValue += model.totalCost;
            
            if (model.totalCost < stats.costRange.min) {
                stats.costRange.min = model.totalCost;
            }
            if (model.totalCost > stats.costRange.max) {
                stats.costRange.max = model.totalCost;
            }
        }
        
        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¬Ù…
        if (model.totalCBM) {
            stats.totalCBM += model.totalCBM;
        }
    });
    
    stats.averageCost = totalCost / allModels.length;
    
    return stats;
}

// Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
function exportModelsData() {
    if (!allModels.length) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
        return;
    }

    const dataStr = JSON.stringify({
        models: allModels,
        modelTypes: modelTypes,
        exportDate: new Date().toISOString()
    }, null, 2);

    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `models_backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    URL.revokeObjectURL(url);
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© changeLanguage Ù„ØªØ´Ù…Ù„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
const originalChangeLanguage = changeLanguage;
changeLanguage = function(lang) {
    originalChangeLanguage(lang);
    
    // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
    const modelSearchInput = document.getElementById('modelSearch');
    if (modelSearchInput) {
        const newPh = modelSearchInput.getAttribute(`data-ph-${currentLang}`);
        if (newPh) modelSearchInput.placeholder = newPh;
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    if (allModels.length > 0) {
        renderModels(allModels);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
    loadModelTypesData();
};

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', () => {
    // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
    initDB().then(() => {
        console.log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª');
    }).catch(error => {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    });
});

// Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
console.log(`
ğŸ›‹ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!

Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
âœ… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ù…Ø¹ Ø¯Ø¹Ù… 3 Ù„ØºØ§Øª
âœ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ÙˆØ§Ù„Ø­Ø¬Ù… (CBM) Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
âœ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ©
âœ… Ù†Ø¸Ø§Ù… Ø·Ø¨Ø§Ø¹Ø© Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
âœ… Ø¥Ø¯Ø§Ø±Ø© Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
âœ… ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙˆØ± Ù…Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø°ÙƒÙŠ
âœ… Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø¨Ø¹Ù…Ù„ØªÙŠÙ†

Ù„Ù„ÙˆØµÙˆÙ„: Ø§Ø®ØªØ± Ù‚Ø³Ù… "Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
`);








        /* ============================================================ */
        /* ğŸ¨ ØªØ­Ø³ÙŠÙ†Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        /* ============================================================ */

        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© Ù„Ù„ØªÙØ§Ø¹Ù„
        function addVisualFeedback() {
            // ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
            document.addEventListener('touchstart', (e) => {
                if (e.target.closest('.material-card, .menu-item')) {
                    e.target.closest('.material-card, .menu-item').style.transform = 'scale(0.98)';
                }
            });
            
            document.addEventListener('touchend', (e) => {
                if (e.target.closest('.material-card, .menu-item')) {
                    setTimeout(() => {
                        e.target.closest('.material-card, .menu-item').style.transform = '';
                    }, 100);
                }
            });
        }

        // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø³Ù„Ø³
        function smoothScrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰
        function addScrollToTopButton() {
            const button = document.createElement('button');
            button.innerHTML = 'â¬†ï¸';
            button.style.cssText = `
                position: fixed;
                bottom: 100px;
                right: 20px;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: var(--primary-color);
                color: white;
                border: none;
                font-size: 20px;
                cursor: pointer;
                opacity: 0;
                transition: opacity 0.3s;
                z-index: 1000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            `;
            
            button.onclick = smoothScrollToTop;
            document.body.appendChild(button);
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø­Ø³Ø¨ Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    button.style.opacity = '1';
                } else {
                    button.style.opacity = '0';
                }
            });
        }

        // ØªÙ‡ÙŠØ¦Ø© ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        document.addEventListener('DOMContentLoaded', () => {
            addVisualFeedback();
            addScrollToTopButton();
        });

        /* ============================================================ */
        /* ğŸ”š Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ - ØªÙ‡ÙŠØ¦Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© */
        /* ============================================================ */

        // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
        console.log(`
        ğŸŒŸ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„ - Ultimate App
        ğŸ“± Ø¥ØµØ¯Ø§Ø±: 2.0
        ğŸš€ ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!
        
        Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©:
        âœ… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª
        âœ… Ø¯Ø¹Ù… 3 Ù„ØºØ§Øª (Ø¹Ø±Ø¨ÙŠØŒ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØŒ ØªØ±ÙƒÙŠ)
        âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
        âœ… Ø·Ø¨Ø§Ø¹Ø© Ø°ÙƒÙŠØ©
        âœ… ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ Ù…Ø­Ø³Ù‘Ù†
        âœ… ÙˆØ§Ø¬Ù‡Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØ¬Ø§ÙˆØ¨Ø©
        
        Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ†: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ IndexedDB
        `);

        // ØªØ­Ø¯ÙŠØ¯ Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        window.APP_VERSION = '2.0.0';
        window.APP_BUILD = new Date().toISOString();

    </script>
</body>
</html>


